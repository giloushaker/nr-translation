import{M as ni,C as nn,a as ri,b as Wi,r as zi,d as Vi,B as me,f as Ht,c as tr,U as tt,I as Vn,e as rt,h as Wr,i as it,R as en,j as Yi,k as Yn,l as zr,P as Qn,m as Qi,G as Xn,E as Hn,L as Vr,n as Xi,o as Hi,F as Zt,g as Yr}from"./C4ErDbKS.js";import{a as Zi,r as ii,h as Ji,b as nt,t as eo,g as to,c as Me,s as no,d as ro,e as io,i as _t,p as Zn,j as oo,k as Qr,l as Xr,f as Hr,m as ao,n as so}from"./CDRs11_G.js";import"./Czx6p1fB.js";import"./lvShBcCt.js";function Zr(k,r){if(k)return k[r]||k["*"]}class uo{index={};words(r){const s=`${r}`;return s.trim().match(/(\w+|\s|\W)/g)??[s]}clean(r){return r.match(/[a-z]/)?r.toLowerCase():r}add(r,s){typeof r!="string"||!r.match(/(?=.*[a-zA-Z0-9].*[a-zA-Z0-9])/)||this.addToIndex(this.index,s,this.words(r))}addToIndex(r,s,c,m=0){if(m<c.length){const _=this.clean(c[m]);_!==" "?(r[_]||(r[_]={}),this.addToIndex(r[_],s,c,m+1)):this.addToIndex(r,s,c,m+1)}else r.$||(r.$=[]),r.$.push(s)}match(r){if(typeof r!="string"||!r.match(/(?=.*[a-zA-Z0-9].*[a-zA-Z0-9])/))return[{text:r}];const s=this.words(r),c=s.map(this.clean,this),m=[];let _=[];for(let C=0;C<c.length;C++){let S=this.index,T=0,B;if(ho(c,C)){let N=co(C,c);N!==-1&&(_.push(s.slice(C,N).join("")),C=N-1);continue}else if(fo(c,C)){let N=lo(C,c);N!==-1&&(_.push(s.slice(C,N).join("")),C=N-1);continue}if(c[C]!==" ")for(let N=C;N<c.length;N++){const q=c[N];if(q!==" ")if(S=S[q],S)S.$&&(T=1+(N-C),B=S.$);else break}T?(_.length&&(m.push({text:_.join("")}),_=[]),m.push({match:B,text:s.slice(C,C+T).join("")}),C+=T-1):_.push(s[C])}return _.length&&m.push({text:_.join("")}),m}}function co(k,r){let s=-1;for(let c=k+3;c<r.length;c++)r[k]==="`"&&r[k+1]==="`"&&r[k+2]==="`"&&(s=c+3);return s}function lo(k,r){let s=-1;for(let c=k+1;c<r.length;c++)(r[k]==="`"||r[k]==`
`)&&(s=c+1);return s}function fo(k,r){return k[r]==="`"}function ho(k,r){return k[r]==="`"&&k[r+1]==="`"&&k[r+2]==="`"}const oi=new Set(["force","roster","self","parent","ancestor","primary-category","force","roster","primary-catalogue","root-entry","unit","model","upgrade","model-or-unit"]);function po(k,r){if(oi.has(r))return!0;const c=k.catalogue.findOptionById(r);if(c&&(c.isForce()&&!k.isForce()||c.isCategory()||c.isCatalogue()))return!0;const m=[k];for(;m.length;){const _=m.pop();if(_.id===r)return!0;_.parent&&m.push(_.parent),_.refs&&m.push(..._.refs)}return!1}function Ge(k){return Zi(k,s=>!(s instanceof ni||s instanceof nn||s instanceof ri||s instanceof Wi))}function yo(k,r){if(!k||!r)return;const s=k.getCatalogue();if(k.parent){const m=Ge(k);if(m){for(const _ of m.constraintsIterator())if(_.id===r)return _}}return s?.findOptionById(r)}function Ue(k,r){if(r===void 0)return"";if(k){if(`${r}`.startsWith("limit::"))return`limit::${Ue(k,ii(`${r}`,"limit::"))}`;const s=k.catalogue||k,c=yo(k,r);if(c){const _=c.type;if(_&&["min","max","exactly"].includes(_))return mo(k,c);if(c.name)return c.isCategory&&c.isCategory()?`${c.name}`:c.url?`${c.name}`:c.name}const m=s.manager;if(m)return(s.manager.findOptionById(r)||m.getCatalogueInfo({targetId:r}))?.name||r}return r}function Jn(k,r,s=!1,c=Ue){const m=r.type||"none",_=r.value===void 0?1:r.percentValue?`${r.value}%`:r.value,C=c(k,r.field),S=["selections","forces"].includes(C)?` ${C}`:` ${c(k,C)}`,T=c(k,r.childId||"")+(s?`(${r.childId||"any"})`:""),B=T&&S?"of ":"",N=c(k,r.scope),q=N===k?.getName()?"":`${N}`,X=r.includeChildSelections?" (recursive)":"",H=q?` in ${q}${X}`:"";switch(m){case"instanceOf":return`${q} is ${T}`;case"notInstanceOf":return`${q} is not ${T}`;case"atLeast":return`${_}+${S} ${B}${T}${H}`;case"greaterThan":return`${Number(_)+1}+${S} ${B}${T}${H}`;case"atMost":return`${_}${_===0?"":"-"}${S} ${B}${T}${H}`;case"lessThan":return`${Number(_)-1}${Number(_)-1===0?"":"-"}${S} ${B}${T}${H}`;case"equalTo":return`${_}${S} ${B}${T}${H}`;case"notEqualTo":return`not ${_}${S} ${B}${T}${H}`;case"none":return`${S} ${B}${T}${H}`;default:return`${m} ${_}${S} ${B}${T}${H}`}}function mo(k,r,s=Ue){if(!Ji(k.constraintsIterator(),r))return r.id;const c=r.field==="selections"?"":` ${s(k,r.field)}`,m=r.scope==="parent"?"":`(${s(k,r.scope)})`,_=r.childId?` ${s(k,r.childId)}`:"";return`${r.type}${c}${_}${m}`}function go(k,r,s=Ue){const c=[];r.scope&&c.push(r.scope),r.affects&&c.push(zi(Vi(r.affects),_=>s(k,_)));const m=c.length?` in ${c.join(".")}`:"";return r.type==="replace"?`${r.type} ${s(k,r.field)} ${r.arg} with ${s(k,r.value?.toString())}${m}`:`${r.type} ${s(k,r.field)} ${s(k,r.value?.toString())}${m}`}typeof $toRaw>"u"&&(globalThis.$toRaw=function(k){return k});class vo extends me{targetId;importRootEntries;isLink(){return!1}}class Jr extends me{shortName;publisher;publicationDate;publisherUrl}class ai extends me{library;revision;gameSystemId;gameSystemRevision;authorContact;authorName;authorUrl;battleScribeVersion;costTypes;catalogueLinks;gameSystem;initialized;loaded_wiki;loaded_editor;imports;importsWithEntries;index;infoIndex;unresolvedLinks={};forces;categories;units;roster_constraints;manager;book;short;version;nrversion;lastUpdated;costIndex;fullFilePath;errors;reset(){delete this.initialized,delete this.loaded,delete this.loaded_editor,delete this.loaded_wiki;for(const r of this.imports||[])delete r.initialized,delete r.loaded,delete r.loaded_editor,delete r.loaded_wiki}init(r=!0){this.initialized||(this.initialized=!0,this.generateImports(r),this.resolveAllLinks(r),this.generateCostIndex(),this.indexInfo())}process(){if(this.loaded)return;this.loaded=!0,this.init();const r=this.generateUnits(),s=this.generateCategories(r);this.categories=Object.values(s),this.generateForces(s,this.forcesIterator()),this.generateExtraConstraints()}processForWiki(r){if(this.loaded_wiki)return;this.loaded_wiki=!0,this.process();const s=r.rules||{};r.rules=s,this.imports.forEach(m=>{nt(m,"refs",this)});function c(m,_){m.id&&(m.parent=_,m.target&&nt(m.target,"refs",_),m instanceof en&&(s[m.id]=m))}Ht(this,c,it);for(const m of this.forces||[]){m.parent=this;for(const _ of m.categories)_.parent=m}}processForEditor(){this.loaded_editor||(this.loaded_editor=!0,this.init(!1),this.gameSystem&&nt(this.gameSystem,"refs",this),Ht(this,(r,s)=>{if(r.parent=s,r.catalogue=this,r.refs||(r.refs=[]),r.other_refs||(r.other_refs=[]),r.target&&nt(r.target,"refs",r),r.isProfile()&&!r.isLink()){const m=this.findOptionById(r.typeId);m&&nt(m,"refs",r)}const c=r.value;if(c){const m=this.findOptionById(c);m&&nt(m,"other_refs",r)}},it),Ht(this,r=>r.isLink()?this.updateLink(r):this.refreshErrors(r),it))}get url(){return"%{book}"}isCatalogue(){return!0}isGameSystem(){return this.gameSystemId===this.id||!this.gameSystemId}isIdUnique(){return!0}getCatalogue(){return this}getGameSystem(){return this.isGameSystem()?this:this.gameSystem}getSystemId(){return this.isGameSystem()?this.id:this.gameSystemId}addError(r,s){this.removeError(r,s.id),r.errors||(r.errors=[]),this.errors||(this.errors=[]),r.errors.push(s),this.errors.push(s)}onRemoveError(r,s=!0){if(this.errors){const c=this.errors.indexOf(r);c>=0&&this.errors.splice(c,1)}if(r.other&&s){const c=r.other;c.getCatalogue()?.removeError(c,"duplicate-id-1",!1),c.getCatalogue()?.removeError(c,"duplicate-id-2",!1)}}removeErrors(r){r.errors?.forEach(s=>this.onRemoveError(s)),r instanceof tr&&r.catalogue.updateConstraint(r,!0),delete r.errors}removeError(r,s,c=!0){r.errors?.length&&(r.errors=r.errors.filter(m=>(m.id===s&&this.onRemoveError(m,c),m.id!==s)))}*iterateCategoryEntries(){for(const r of this.imports)for(const s of r.categoryEntries||[])yield s;this.categoryEntries&&(yield*this.categoryEntries)}*iterateCostTypes(){for(const r of this.imports)for(const s of r.costTypes||[])yield s;this.costTypes&&(yield*this.costTypes)}*forcesIterator(){for(const r of this.imports)for(const s of r.forceEntries||[])yield s;this.forceEntries&&(yield*this.forceEntries)}*forcesIteratorRecursive(){if(this.forces)for(const r of this.forces)yield r,yield*r.forcesIteratorRecursive()}*iterateProfileTypes(){for(const r of this.imports)r.profileTypes&&(yield*r.profileTypes);this.profileTypes&&(yield*this.profileTypes)}*iteratePublications(){for(const r of this.imports)for(const s of r.publications||[])yield s;for(const r of this.publications||[])yield r}*iterateSelectionEntries(){for(const r of this.importsWithEntries){for(const s of r.sharedSelectionEntries||[])yield s;for(const s of r.sharedSelectionEntryGroups||[])yield s}this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllImported(){const r=["sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","categoryEntries"],s=["rules","entryLinks","profiles","infoGroups","selectionEntries","selectionEntryGroups"];for(const c of this.importsWithEntries)for(const m of s)for(const _ of c[m]||[])_.import!==!1&&(yield _);for(const c of this.imports)for(const m of r)for(const _ of c[m]||[])yield _;for(const c of s)for(const m of this[c]||[])yield m;for(const c of r)for(const m of this[c]||[])yield m}*iterateSelectionEntriesWithRoot(){for(const r of this.importsWithEntries){for(const s of r.selectionEntries||[])s.import!==!1&&(yield s);for(const s of r.entryLinks||[])s.import!==!1&&(yield s);for(const s of r.sharedSelectionEntries||[])yield s;for(const s of r.sharedSelectionEntryGroups||[])yield s}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllRootEntries(){for(const r of this.importsWithEntries){for(const s of r.selectionEntries||[])s.import!==!1&&(yield s);for(const s of r.entryLinks||[])s.import!==!1&&(yield s)}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks)}*entriesIterator(){this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.selectionEntries&&(yield*this.selectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}forEachNode(r){if(r(this),this.childs)for(const s of this.childs)s.forEachNode(r)}*selectionsIterator(){yield*this.forces}findOptionById(r){const s=this.index[r];if(s)return s;const c=this.imports.find(m=>r in m.index)?.index[r];if(c)return c;if(this.manager&&r)return this.manager.getLoadedCatalogue(r)??this.manager.getCatalogueInfo({targetId:r})}findOptionByIdGlobal(r){const s=this.index[r];if(s)return s;const c=this.imports.find(m=>r in m.index)?.index[r];if(c)return c;if(this.manager){const m=this.manager.findOptionById(r);return m||this.manager.getCatalogueInfo({targetId:r})}}findOptionsById(r){const s=[];for(const c of[this,...this.imports])for(const m of Object.values(c.index))m.id&&m.id===r&&s.push(m);return s}findOptionsByText(r,s=!1){if(!r||!r.trim()||s){const _=[];for(const C of[this,...this.imports])for(const S of Object.values(C.index))if(S.getName){if(S.isLink()&&S.target&&S.isCategory()&&!S.parent?.isForce())continue;s?S.getName()===r&&_.push(S):_.push(S)}return _}const c=[],m=eo(r);for(const _ of[this,...this.imports])for(const C of Object.values(_.index)){const S=C.getName?.call(C),T=C.id;if(S&&String(S).match(m)||T===r){if(C.isLink()&&C.target&&C.isCategory()&&!C.parent?.isForce())continue;c.push(C)}}return c}findForceByPath(r){if(!r.length)return;let s=this;for(const c of r)s=s?.forces?.find(m=>m.id===c);return s}generateNonConflictingId(r){if(r&&this.findOptionByIdGlobal(r)===void 0)return r;for(;;){const s=to();if(this.findOptionById(s)===void 0)return s}}generateCostIndex(){const r={};for(const s of this.imports)for(const c of s.costTypes||[])r[c.id]=c,this.index[c.id]=c;for(const s of this.costTypes||[])r[s.id]=s,this.index[s.id]=s;return this.costIndex=r,r}getSystem(){return this.gameSystem??this}indexInfo(){const r=this.gameSystem??this;r===this&&(r.infoIndex=new uo);const s=r.infoIndex;if(!s)throw new Error("Couldn't index info: system isn't initialized");this.forEachObjectWhitelist((c,m)=>{if(!c.isLink()&&(c.isProfile()||c.isRule()||c.isCategory())&&(c.noindex||s.add(c.getName(),c),c.alias))for(const _ of c.alias){const C=Me(c);C.name=_,s.add(_,C)}})}generateImports(r=!0){const s={},c={};this.gameSystem&&(this.gameSystem.init(r),s[this.gameSystem.id]=this.gameSystem,c[this.gameSystem.id]=this.gameSystem,this.gameSystem.import||(this.gameSystem.imports=[]));for(const m of this.catalogueLinks||[]){const _=m.target;if(_){_.init(r);for(const C of _.imports)c[C.id]=C;for(const C of _.importsWithEntries)s[C.id]=C;m.importRootEntries&&(s[_.id]=_),c[_.id]=_}}return this.imports=Object.values(c),this.importsWithEntries=Object.values(s),this.imports}generateForces(r,s,c){c||(c=this);const m=[];for(const _ of s){const C=Me(_);C.main_catalogue=this;const S=[],T=new Set;if(r[tt]?.units?.length){S.push(r[tt]);for(const N of r[tt].childs)T.add(N.id)}for(const N of _.categoryLinks||[])if(N.targetId in r){const q=Me(N);q.main_catalogue=this;const X=r[q.targetId];q.target=X,q.childs=X.childs;for(const H of q.childs)T.add(H.id);S.push(q)}for(const N of _.categoryEntries||[])if(N.id in r){const q=r[N.id],X=Me(q);X.main_catalogue=this;for(const H of X.childs)T.add(H.id);S.push(X)}const B=this.units.filter(N=>!T.has(N.id));if(B.length){const N=Me(r[Vn]);N.childs=B,N.units=B,S.push(N)}C.childs=S,C.categories=S,this.index[C.id]=C,C.forceEntries&&C.generateForces(r),this.generateForces(r,C.forcesIterator(),C),m.push(C)}return no(m,_=>_.sortIndex??1e3),c.forces=m,c.childs=m,m}generateCategories(r){const s={},c=new Set;for(const S of this.iterateCategoryEntries()){const T=Me(S);T.main_catalogue=this;const B=r[T.id]||[];T.units=B,T.childs=B,this.index[S.id]=S,s[T.id]=T,c.add(T.id)}for(const S in r)if(!c.has(S)){const T=this.findOptionById(S);if(T){const B=Me(T);B.main_catalogue=this;const N=r[B.id]||[];B.units=N,B.childs=N,this.index[T.id]=T,s[B.id]=B}}const m=r[tt]||[],_={name:"Uncategorized",id:tt,hidden:!1,units:m,childs:m,catalogue:this};s[tt]=Object.setPrototypeOf(_,rt.prototype);const C={name:"Illegal Units",id:Vn,hidden:!0,units:[],childs:[],catalogue:this};return s[Vn]=Object.setPrototypeOf(C,rt.prototype),s}generateUnits(){const r=[];for(const m of this.importsWithEntries){const _=m.isGameSystem();for(const C of m.selectionEntries||[])(_||C.import!==!1)&&r.push(C);for(const C of m.entryLinks||[])(_||C.import!==!1)&&r.push(C)}for(const m of this.selectionEntries||[])r.push(m);for(const m of this.entryLinks||[])r.push(m);const s=ro(r,m=>m.getName());return this.units=s,io(s,m=>m.getPrimaryCategory())}generateExtraConstraints(){const r={},s=[],c={},m=new Set,_={};function C(S,T,B){const N=T.target||T;for(const q of B){if(q.type==="max")continue;const X=`${q.id}::${T.id}`;switch(q.scope){case"parent":break;case"roster":r[X]=T.getBoundConstraint(q);break;case"force":s.push(T.getBoundConstraint(q));break;case"primary-category":case"primary-catalogue":break;default:if(m.has(q.scope)){_t(c,q.scope,N.getBoundConstraint(q));break}const H=S.index[q.scope];if(H){const ie=H.extra_constraints||[];ie.push(T.getBoundConstraint(q)),H.extra_constraints=ie;break}break}}}for(const S of this.forcesIteratorRecursive())C(this,S,S.constraintsIterator()),m.add(S.id);for(const S of this.categories)m.add(S.id);for(const S of this.categories){C(this,S,S.constraintsIterator());const T={};S.forEachNodeCb(B=>{if(B&&!B.isForce()&&(!B.isGroup()&&!B.extra_constraints&&(B.extra_constraints=B.getChildBoundConstraints(!0)),!(B.isCategory()&&B.isLink())&&!(!B.constraints&&!B.target?.constraints))){for(const N of B.constraintsIterator())if(N.type==="min"||N.type==="exactly"){const q=`${N.id}::${B.id}`;switch(N.scope){case"parent":break;case"roster":r[q]=B.getBoundConstraint(N);break;case"force":T[q]=B.getBoundConstraint(N);break;case"primary-category":case"primary-catalogue":break;default:if(m.has(N.scope)){_t(c,N.scope,B.getBoundConstraint(N));break}const X=this.index[N.scope];if(X){const H=X.extra_constraints||[];H.push(B.getBoundConstraint(N)),X.extra_constraints=H;break}break}}}}),_[S.getId()]=Object.values(T)}for(const S of this.forcesIteratorRecursive()){const T=S.extra_constraints||[];T.push(...s),S.id in c&&T.push(...c[S.id]),T.length&&(S.extra_constraints=T);for(const B of S.categories)B.getId()in _&&T.push(..._[B.getId()]);T.length&&(S.extra_constraints=T);for(const B of S.forcesIterator())for(const N of B.constraintsIterator())(N.type==="min"||N.type==="exactly")&&["parent","force",B.id].includes(N.scope)&&T.push(B.getBoundConstraint(N))}for(const S of this.categories){const T=S.extra_constraints||[];S.id in c&&T.push(...c[S.id]),T.length&&(S.extra_constraints=T)}this.roster_constraints=Object.values(r)}async reload(r=this.manager){delete this.initialized,delete this.loaded,delete this.loaded_editor;const s=this.refs;delete this.index;const c=this.isGameSystem()?"gameSystem":"catalogue",m=await r.loadData({[c]:this});if(this.processForEditor(),s)for(const _ of s)_.editorTypeName==="catalogueLink"&&await _.catalogue?.reload(r);return m}refreshErrors(r,s=!1){if(this.removeErrors(r),r.comment?.startsWith("todo:")?this.addError(r,{source:r,severity:"info",msg:`${r.getName()}: ${r.comment}`,id:"comment"}):r.comment?.startsWith("warning:")?this.addError(r,{source:r,severity:"warning",msg:`${r.getName()}: ${r.comment}`,id:"comment"}):r.comment?.startsWith("error:")?this.addError(r,{source:r,severity:"error",msg:`${r.getName()}: ${r.comment}`,id:"comment"}):this.removeError(r,"comment"),r.isLink()){r.target?(Zn(this.unresolvedLinks,r.targetId,$toRaw(r)),Zn(this.manager.unresolvedLinks,r.targetId,$toRaw(r))):(this.addError(r,{source:r,severity:"error",msg:`(${r.editorTypeName}) ${r.name} has no target`,id:"no-target"}),!this.unresolvedLinks[r.targetId]?.includes($toRaw(r))&&!s&&_t(this.unresolvedLinks,r.targetId,$toRaw(r)),this.manager.unresolvedLinks[r.targetId]?.includes($toRaw(r))||_t(this.manager.unresolvedLinks,r.targetId,$toRaw(r)));const c=nr(r.targetId,this.getIndexes());if(Oo(r).find(_=>_.id===r.targetId))r.catalogue.addError(r,{id:"bad-link-target",msg:"Link target cannot be itself or include itself as a child",source:r});else if(c?.isLink()){r.catalogue.addError(r,{id:"bad-link-target",msg:"Link target Cannot be a Link",source:r});return}}else r.isProfile()?r.typeId||this.addError(r,{source:r,severity:"error",msg:"Profile has no type",id:"no-profile-type"}):r instanceof nn&&this.updateCondition(r)}addToIndex(r){if(r.id){if(r.catalogue=this,this.manager?.settings?.globalDuplicateIdError){const s=this.manager.index;if(s[r.id]&&s[r.id]!==r&&(r.isIdUnique()||s[r.id].isIdUnique())){const c=s[r.id],m=c.getCatalogue();m&&this!==m&&(m.addError(c,{source:c,severity:"error",msg:`Duplicate id ${r.id} ${r.getName()}`,id:"duplicate-id-1",other:r,extra:m.name}),m.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${c.getName()}`,id:"duplicate-id-2",other:c,extra:this.name}),this.addError(c,{source:c,severity:"error",msg:`Duplicate id ${r.id}  ${r.getName()}`,id:"duplicate-id-1",other:r,extra:m.name}),this.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${c.getName()}`,id:"duplicate-id-2",other:c,extra:this.name}))}s[r.id]=r}else if(this.index[r.id]&&this.index[r.id]!==r){const s=this.index[r.id];(r.isIdUnique()||s.isIdUnique()||r.getName()!==s.getName())&&(this.addError(s,{source:s,severity:"error",msg:`Duplicate id ${r.id} ${r.getName()}`,id:"duplicate-id-1",other:r}),this.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${s.getName()}`,id:"duplicate-id-2",other:s}))}if(this.index[r.id]=r,this.unresolvedLinks&&this.unresolvedLinks[r.id])for(const s of[...this.unresolvedLinks[r.id]])s.isLink()&&s.catalogue?this.updateLink(s):this.refreshErrors(s);if(this.manager?.unresolvedLinks&&this.manager.unresolvedLinks[r.id]?.length)for(const s of[...this.manager.unresolvedLinks[r.id]])s.isLink()?s.catalogue?.updateLink(s):s.catalogue?.refreshErrors(s)}}removeFromIndex(r){r.id&&$toRaw(this.index[r.id])===$toRaw(r)&&delete this.index[r.id],this.removeErrors(r);for(const s of r.refs||[])delete s.target,s.catalogue.refreshErrors(s);for(const s of r.other_refs||[])s.catalogue?.refreshErrors(s,!0)}getIndexes(){const r=[];r.push(this.index);for(const s of this.imports)r.push(s.index);return r}resolveAllLinks(r=!0){const s=[],c=[],m=[];this.index=Eo(),Ht(this,(S,T)=>{this.addToIndex(S),S.publicationId&&(delete S.publication,c.push(S)),S.isLink()&&(delete S.target,s.push(S),m.push(T)),xo(S)},it);const _=this.getIndexes(),C=wo(s,_,m,r);if(_o(c,_),!r){this.unresolvedLinks={};for(const S of C)_t(this.unresolvedLinks,S.targetId,$toRaw(S)),delete S.target}}removeRef(r,s){s.refs||(s.refs=[]);const c=s.refs.indexOf(r);c>=0&&s.refs.splice(c,1)}addRef(r,s){s.refs||(s.refs=[]),s.refs.indexOf(r)===-1&&s.refs.push(r)}hasOtherRef(r,s){return s.other_refs&&s.other_refs.includes(r)}removeOtherRef(r,s){s.other_refs||(s.other_refs=[]);const c=s.other_refs.indexOf(r);c>=0&&s.other_refs.splice(c,1)}addOtherRef(r,s){s.other_refs||(s.other_refs=[]),s.other_refs.indexOf(r)===-1&&s.other_refs.push(r)}updateLink(r){r.target&&this.removeRef(r,r.target);const s=nr(r.targetId,this.getIndexes());if(r.target=s,r.target){r.name=s.name,this.addRef(r,r.target);const c=r.target.editorTypeName;c=="categoryEntry"?delete r.type:r.type=c}return this.refreshErrors(r),r.target!==void 0}updateConstraint(r,s=!1){const c=new Set,m=new Set;for(const _ of r.parent?.constraintsIterator()||[])s&&r===_||(c.has(_.id)?m.add(_.id):c.add(_.id));for(const _ of r.parent?.constraintsIterator()||[])s&&r===_||(m.has(_.id)?_.catalogue?.addError(_,{id:"duplicate-constraint-id",msg:"Duplicate constraints id",source:r}):_.catalogue?.removeError(_,"duplicate-constraint-id"))}updateCondition(r,s){if(r.scope){const m=Ge(r);if(m&&!po(m,r.scope)?this.addError(r,{source:r,id:"invalid-scope",msg:`Invalid scope ${r.scope}`}):this.removeError(r,"invalid-scope"),r.scope&&!oi.has(r.scope)){const _=this.findOptionById(r.scope);_&&_.getCatalogue().addOtherRef(r,_)}}if(r instanceof tr)return this.updateConstraint(r);const c=["instanceOf","notInstanceOf"].includes(r.type);if(s&&!Wr.has(s)){const m=c?this.findOptionByIdGlobal(s):this.findOptionById(s);m&&this.removeOtherRef(r,m)}if(r.childId){if(Wr.has(r.childId)){this.removeError(r,"id-not-exist");return}const m=c?this.findOptionByIdGlobal(r.childId):this.findOptionById(r.childId);if(m){this.hasOtherRef(r,m)||this.addOtherRef(r,m),this.removeError(r,"id-not-exist"),Zn(this.manager.unresolvedLinks,r.childId,$toRaw(r));return}}r.editorTypeName!=="localConditionGroup"&&this.addError(r,{source:r,severity:"warning",msg:"child id does not exist",id:"id-not-exist"}),oo(this.manager.unresolvedLinks,r.childId,$toRaw(r))}unlinkLink(r){r.target&&this.removeRef(r,r.target)}getForceLabel(){return this.gameSystem.getForceLabel()}}class bo extends ai{forceLabel;getForceLabel(){return this.forceLabel??"Force"}}function nr(k,r){for(const s of r)if(k in s)return s[k]}function wo(k=[],r,s,c=!0){k.length;let m=0;for(;k.length!==m;){const _=k,C=s;m=_.length,k=[],s=[];for(let S=0;S<_.length;S++){const T=_[S],B=C[S],N=T.targetId,q=nr(N,r);if(q){q.isLink()?console.warn(`Failed to resolve link (target is a link): ${T.getName()}(${T.id})`):T.target=q;continue}k.push(T),s.push(B)}}if(k.length&&c)for(let _=0;_<k.length;_++){const C=k[_],S=s[_];for(const[T,B]of Object.entries(S))if(B===C&&delete S[T],Array.isArray(B))for(const N in B)B[N]===C&&B.splice(N,1)}return k}function _o(k=[],r){for(const s of k)for(const c of r)if(s.publicationId in c){s.publication=c[s.publicationId];break}}function xo(k){return k.shared!==!1&&k.childId!==void 0}let ko=class{get[Symbol.toStringTag](){return"ObjectNoObserve"}};function Eo(){return new ko}function Oo(k){const r=[];if(k.isCatalogue()||!k.parent&&!k.refs?.length)return r;let s=[];const c=[],m=[k.parent,...k?.refs??[]].filter(Boolean),_=new Set;for(;m.length;){for(c.push(m.shift()),s=[];c.length;){const C=c.pop();_.has(C.id)||(_.add(C.id),s.push(C),C.parent&&!C.parent.isCatalogue()&&c.push(C.parent),C.refs&&m.push(...C.refs))}r.push(...s.reverse())}return r.filter(C=>C.editorTypeName!=="catalogueLink")}function si(k,r){if(r?.target)return si(r.target.parentKey,r.target)+"Link";const s=Yi[k]?.type;return s||k}function ui(k){const r=k.parentKey;switch(r){case"selectionEntries":case"sharedSelectionEntries":case"selectionEntryGroups":case"sharedSelectionEntryGroups":case"entryLinks":case"forceEntries":case"categoryLinks":case"categoryEntries":case"sharedInfoGroups":case"infoGroups":case"catalogueLinks":case"publications":case"profileTypes":case"catalogue":case"gameSystem":case"rules":case"sharedRules":case"costs":case"costTypes":case"sharedProfiles":case"profiles":case"attributes":case"attributeTypes":case"characteristics":case"characteristicTypes":return k.getName();case"modifiers":return go(Ge(k),k);case"repeats":{const c=k,m=Ge(k);return m||console.error("no parent for repeat",k),`Repeat ${c.repeats} times for every ${c.value} ${Ue(m,c.field)} in ${Ue(m,c.scope)} of ${c.childId?Ue(m,c.childId):" any"}`+(c.includeChildSelections?" (recursive)":"")}case"constraints":const s=k;return Jn(Ge(k),s);case"conditions":return Jn(Ge(k),k);case"localConditionGroups":return Jn(Ge(k),k)+" where:";case"modifierGroups":return"Modify...";case"conditionGroups":return`${k.type.toUpperCase()}`;case"infoLinks":return k.target?ui(k.target):k.getName();case"associations":return k.name;default:return console.log(r,k),r}}class Io{get[Symbol.toStringTag](){return"ObjectNoObserve"}}function So(){return new Io}const Co={};function Po(k,r,s){if(r in k)return k[r];class c extends me{parent;get parentKey(){return r}get editorTypeName(){return si(r,this)}toString(){return`${this.editorTypeName} - ${ui(this)}`}}return c.prototype.parentKey,Object.setPrototypeOf(c.prototype,Object.getPrototypeOf(s)),k[r]=c.prototype,c.prototype}function Ko(k,r,s){Object.setPrototypeOf(s,Po(k,r,s))}const er={"*":me.prototype,catalogue:ai.prototype,catalogueLinks:vo.prototype,gameSystem:bo.prototype,forceEntries:Zt.prototype,forces:Zt.prototype,forceEntry:Zt.prototype,force:Zt.prototype,categoryEntries:rt.prototype,categoryEntry:rt.prototype,category:rt.prototype,categories:rt.prototype,link:Vr.prototype,infoLinks:Hi.prototype,categoryLinks:Xi.prototype,entry:Hn.prototype,selectionEntries:Hn.prototype,entryLinks:Vr.prototype,sharedSelectionEntries:Hn.prototype,group:Xn.prototype,selectionEntryGroups:Xn.prototype,sharedSelectionEntryGroups:Xn.prototype,sharedRules:en.prototype,rules:en.prototype,rule:en.prototype,profileTypes:Qi.prototype,sharedProfiles:Qn.prototype,profiles:Qn.prototype,profile:Qn.prototype,characteristics:zr.prototype,characteristic:zr.prototype,characteristicTypes:me.prototype,characteristicType:me.prototype,sharedInfoGroups:Yn.prototype,infoGroups:Yn.prototype,infoGroup:Yn.prototype,publications:Jr.prototype,publication:Jr.prototype,repeats:nn.prototype,conditions:nn.prototype,constraints:tr.prototype,modifiers:ni.prototype,modifierGroups:ri.prototype};function To(k){return k in er?er[k]:er["*"]}function rr(k,r){const s=To(r);return s&&(Object.setPrototypeOf(k,s),k.post_init&&k.post_init(),globalThis.isEditor&&Ko(k.keyInfoCache||Co,r,k)),k}function Ao(k){const r=[k];for(;r.length;){const s=r.pop();for(const c of Object.keys(s)){const m=s[c];if(Qr(m))if(Array.isArray(m)){if(m.length&&Qr(m[0]))for(let _=m.length;_--;){const C=m[_];Xr(C)&&(rr(C,c),r.push(C))}}else Xr(m)&&(rr(m,c),r.push(m))}}}async function rn(k,r,s,c){if(!r.catalogue&&!r.gameSystem)throw Error("invalid loadBsData argument: no .catalogue or .gameSystem in data");const m=r.catalogue?"catalogue":"gameSystem",_=m==="gameSystem",C=m==="catalogue",S=r[m],T=S;if(T instanceof me)return T;Ao(S);const B=rr(S,m);if(B.manager=k,C){const q={targetId:B.gameSystemId},X=k.getLoadedCatalogue(q,s);if(X)B.gameSystem=X;else{const H=await k.getData(q,s),ie=k.getLoadedCatalogue(q,s);ie?B.gameSystem=ie:B.gameSystem=await rn(k,H,s)}}const N=[];for(const q of B?.catalogueLinks||[]){if(!q.targetId){console.warn(`invalid link: no targetId in link: ${q}, found in ${S.name}`);continue}if(q.targetId===B.id){q.target=B;continue}const X=k.getLoadedCatalogue(q,s);if(X){q.target=X;continue}const H=k.getData(q,s).then(ie=>{const ge=k.getLoadedCatalogue(q,s);if(ge){q.target=ge;return}return rn(k,ie,s).then(an=>q.target=an)});N.push(H)}return await Promise.all(N),_&&k.addLoadedSystem(B),C&&k.addLoadedCatalogue(B),B}class $o{catalogues={};unresolvedLinks;settings;system;translations;async getData(r,s){throw new Error("Method not implemented.")}async loadAll(){throw new Error("Method not implemented.")}async translate(r){if(this.translations){const s=this.translations;Hr(Yr(r),(c,m,_)=>{typeof c=="string"&&c in s&&(_[m]=s[c],_[`original_${m}`]=c)},(c,m)=>!(!it.has(m)||!(c instanceof me)))}}async untranslate(r){Hr(Yr(r),(s,c,m)=>{if(c.startsWith("original_")){const _=ii(c,"original_");m[_]=s,delete m[c]}},(s,c)=>!(!it.has(c)||!(s instanceof me)))}async setTranslations(r){const s=this.translations;this.translations=r??void 0;for(const c of this.getAllLoadedCatalogues())s&&await this.untranslate(c),r&&await this.translate(c)}getTranslations(){return this.translations}getCatalogueInfo(r){return this.system?.books.array?.find(s=>s.bsid===r.targetId)}findOptionById(r){}getLoadedCatalogue(r,s){const c=typeof r=="string"?r:r.targetId||r.name,m=Zr(s,c)||"default",_=this.catalogues[c];return _?_[m]:void 0}getAllLoadedCatalogues(){return Object.values(this.catalogues).map(r=>Object.values(r)).flat(1)}addLoadedCatalogue(r,s){const c=Zr(s,r.id)||"default";this.catalogues[r.name]||(this.catalogues[r.name]={}),this.catalogues[r.id]||(this.catalogues[r.id]={}),this.catalogues[r.name][c]=r,this.catalogues[r.id][c]=r}addLoadedSystem(r,s){return this.addLoadedCatalogue(r,s)}unloadAll(){this.catalogues={}}async loadData(r,s){const c=await rn(this,r,s);return c.process(),c}async loadCatalogue(r,s,c){const m=this.getLoadedCatalogue(r,s);if(m&&!c)return m;const _=await this.getData(r,s);if(_)return await this.loadData(_,s);throw Error(`Couldn't load catalogue: couldn't getData ${r}`)}}var tn={exports:{}},Ro=tn.exports,ei;function Bo(){return ei||(ei=1,function(k,r){(function(s,c){k.exports=c()})(Ro,function(){var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(n[o]=i[o])})(e,t)},c=function(){return(c=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function m(e,t,n){for(var i,o=0,a=t.length;o<a;o++)!i&&o in t||((i=i||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(i||Array.prototype.slice.call(t))}var _=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:ao,C=Object.keys,S=Array.isArray;function T(e,t){return typeof t!="object"||C(t).forEach(function(n){e[n]=t[n]}),e}typeof Promise>"u"||_.Promise||(_.Promise=Promise);var B=Object.getPrototypeOf,N={}.hasOwnProperty;function q(e,t){return N.call(e,t)}function X(e,t){typeof t=="function"&&(t=t(B(e))),(typeof Reflect>"u"?C:Reflect.ownKeys)(t).forEach(function(n){ie(e,n,t[n])})}var H=Object.defineProperty;function ie(e,t,n,i){H(e,t,T(n&&q(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},i))}function ge(e){return{from:function(t){return e.prototype=Object.create(t.prototype),ie(e.prototype,"constructor",e),{extend:X.bind(null,e.prototype)}}}}var an=Object.getOwnPropertyDescriptor,ci=[].slice;function xt(e,t,n){return ci.call(e,t,n)}function or(e,t){return t(e)}function ot(e){if(!e)throw new Error("Assertion Failed")}function ar(e){_.setImmediate?setImmediate(e):setTimeout(e,0)}function ve(e,t){if(typeof t=="string"&&q(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var n=[],i=0,o=t.length;i<o;++i){var a=ve(e,t[i]);n.push(a)}return n}var u=t.indexOf(".");if(u!==-1){var l=e[t.substr(0,u)];return l==null?void 0:ve(l,t.substr(u+1))}}function ce(e,t,n){if(e&&t!==void 0&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){ot(typeof n!="string"&&"length"in n);for(var i=0,o=t.length;i<o;++i)ce(e,t[i],n[i])}else{var a,u,l=t.indexOf(".");l!==-1?(a=t.substr(0,l),(u=t.substr(l+1))===""?n===void 0?S(e)&&!isNaN(parseInt(a))?e.splice(a,1):delete e[a]:e[a]=n:ce(l=!(l=e[a])||!q(e,a)?e[a]={}:l,u,n)):n===void 0?S(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function sr(e){var t,n={};for(t in e)q(e,t)&&(n[t]=e[t]);return n}var li=[].concat;function ur(e){return li.apply([],e)}var Ae="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(ur([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return _[e]}),cr=new Set(Ae.map(function(e){return _[e]})),at=null;function Pe(e){return at=new WeakMap,e=function t(n){if(!n||typeof n!="object")return n;var i=at.get(n);if(i)return i;if(S(n)){i=[],at.set(n,i);for(var o=0,a=n.length;o<a;++o)i.push(t(n[o]))}else if(cr.has(n.constructor))i=n;else{var u,l=B(n);for(u in i=l===Object.prototype?{}:Object.create(l),at.set(n,i),n)q(n,u)&&(i[u]=t(n[u]))}return i}(e),at=null,e}var fi={}.toString;function sn(e){return fi.call(e).slice(8,-1)}var un=typeof Symbol<"u"?Symbol.iterator:"@@iterator",di=typeof un=="symbol"?function(e){var t;return e!=null&&(t=e[un])&&t.apply(e)}:function(){return null};function Ke(e,t){return t=e.indexOf(t),0<=t&&e.splice(t,1),0<=t}var We={};function be(e){var t,n,i,o;if(arguments.length===1){if(S(e))return e.slice();if(this===We&&typeof e=="string")return[e];if(o=di(e)){for(n=[];!(i=o.next()).done;)n.push(i.value);return n}if(e==null)return[e];if(typeof(t=e.length)!="number")return[e];for(n=new Array(t);t--;)n[t]=e[t];return n}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var cn=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},ct=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],de=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(ct),hi={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function ze(e,t){this.name=e,this.message=t}function lr(e,t){return e+". Errors: "+Object.keys(t).map(function(n){return t[n].toString()}).filter(function(n,i,o){return o.indexOf(n)===i}).join(`
`)}function kt(e,t,n,i){this.failures=t,this.failedKeys=i,this.successCount=n,this.message=lr(e,t)}function Ve(e,t){this.name="BulkError",this.failures=Object.keys(t).map(function(n){return t[n]}),this.failuresByPos=t,this.message=lr(e,this.failures)}ge(ze).from(Error).extend({toString:function(){return this.name+": "+this.message}}),ge(kt).from(ze),ge(Ve).from(ze);var ln=de.reduce(function(e,t){return e[t]=t+"Error",e},{}),pi=ze,M=de.reduce(function(e,t){var n=t+"Error";function i(o,a){this.name=n,o?typeof o=="string"?(this.message="".concat(o).concat(a?`
 `+a:""),this.inner=a||null):typeof o=="object"&&(this.message="".concat(o.name," ").concat(o.message),this.inner=o):(this.message=hi[t]||n,this.inner=null)}return ge(i).from(pi),e[t]=i,e},{});M.Syntax=SyntaxError,M.Type=TypeError,M.Range=RangeError;var fr=ct.reduce(function(e,t){return e[t+"Error"]=M[t],e},{}),Et=de.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=M[t]),e},{});function Q(){}function st(e){return e}function yi(e,t){return e==null||e===st?t:function(n){return t(e(n))}}function Te(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function mi(e,t){return e===Q?t:function(){var n=e.apply(this,arguments);n!==void 0&&(arguments[0]=n);var i=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var a=t.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?Te(i,this.onsuccess):i),o&&(this.onerror=this.onerror?Te(o,this.onerror):o),a!==void 0?a:n}}function gi(e,t){return e===Q?t:function(){e.apply(this,arguments);var n=this.onsuccess,i=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?Te(n,this.onsuccess):n),i&&(this.onerror=this.onerror?Te(i,this.onerror):i)}}function vi(e,t){return e===Q?t:function(n){var i=e.apply(this,arguments);T(n,i);var o=this.onsuccess,a=this.onerror;return this.onsuccess=null,this.onerror=null,n=t.apply(this,arguments),o&&(this.onsuccess=this.onsuccess?Te(o,this.onsuccess):o),a&&(this.onerror=this.onerror?Te(a,this.onerror):a),i===void 0?n===void 0?void 0:n:T(i,n)}}function bi(e,t){return e===Q?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function fn(e,t){return e===Q?t:function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){for(var i=this,o=arguments.length,a=new Array(o);o--;)a[o]=arguments[o];return n.then(function(){return t.apply(i,a)})}return t.apply(this,arguments)}}Et.ModifyError=kt,Et.DexieError=ze,Et.BulkError=Ve;var he=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function dr(e){he=e}var ut={},hr=100,Ae=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,B(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,B(t),e]}(),ct=Ae[0],de=Ae[1],Ae=Ae[2],de=de&&de.then,$e=ct&&ct.constructor,dn=!!Ae,lt=function(e,t){ft.push([e,t]),Ot&&(queueMicrotask(_i),Ot=!1)},hn=!0,Ot=!0,Re=[],It=[],pn=st,xe={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Q,pgp:!1,env:{},finalize:Q},F=xe,ft=[],Be=0,St=[];function j(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var t=this._PSD=F;if(typeof e!="function"){if(e!==ut)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&mn(this,this._value))}this._state=null,this._value=null,++t.ref,function n(i,o){try{o(function(a){if(i._state===null){if(a===i)throw new TypeError("A promise cannot be resolved with itself.");var u=i._lib&&Ye();a&&typeof a.then=="function"?n(i,function(l,d){a instanceof j?a._then(l,d):a.then(l,d)}):(i._state=!0,i._value=a,yr(i)),u&&Qe()}},mn.bind(null,i))}catch(a){mn(i,a)}}(this,e)}var yn={get:function(){var e=F,t=Tt;function n(i,o){var a=this,u=!e.global&&(e!==F||t!==Tt),l=u&&!Ee(),d=new j(function(p,v){gn(a,new pr(gr(i,e,u,l),gr(o,e,u,l),p,v,e))});return this._consoleTask&&(d._consoleTask=this._consoleTask),d}return n.prototype=ut,n},set:function(e){ie(this,"then",e&&e.prototype===ut?yn:{get:function(){return e},set:yn.set})}};function pr(e,t,n,i,o){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=n,this.reject=i,this.psd=o}function mn(e,t){var n,i;It.push(t),e._state===null&&(n=e._lib&&Ye(),t=pn(t),e._state=!1,e._value=t,i=e,Re.some(function(o){return o._value===i._value})||Re.push(i),yr(e),n&&Qe())}function yr(e){var t=e._listeners;e._listeners=[];for(var n=0,i=t.length;n<i;++n)gn(e,t[n]);var o=e._PSD;--o.ref||o.finalize(),Be===0&&(++Be,lt(function(){--Be==0&&vn()},[]))}function gn(e,t){if(e._state!==null){var n=e._state?t.onFulfilled:t.onRejected;if(n===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Be,lt(wi,[n,e,t])}else e._listeners.push(t)}function wi(e,t,n){try{var i,o=t._value;!t._state&&It.length&&(It=[]),i=he&&t._consoleTask?t._consoleTask.run(function(){return e(o)}):e(o),t._state||It.indexOf(o)!==-1||function(a){for(var u=Re.length;u;)if(Re[--u]._value===a._value)return Re.splice(u,1)}(t),n.resolve(i)}catch(a){n.reject(a)}finally{--Be==0&&vn(),--n.psd.ref||n.psd.finalize()}}function _i(){De(xe,function(){Ye()&&Qe()})}function Ye(){var e=hn;return Ot=hn=!1,e}function Qe(){var e,t,n;do for(;0<ft.length;)for(e=ft,ft=[],n=e.length,t=0;t<n;++t){var i=e[t];i[0].apply(null,i[1])}while(0<ft.length);Ot=hn=!0}function vn(){var e=Re;Re=[],e.forEach(function(i){i._PSD.onunhandled.call(null,i._value,i)});for(var t=St.slice(0),n=t.length;n;)t[--n]()}function Ct(e){return new j(ut,!1,e)}function J(e,t){var n=F;return function(){var i=Ye(),o=F;try{return Oe(n,!0),e.apply(this,arguments)}catch(a){t&&t(a)}finally{Oe(o,!1),i&&Qe()}}}X(j.prototype,{then:yn,_then:function(e,t){gn(this,new pr(null,null,e,t,F))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=e,n=arguments[1];return typeof t=="function"?this.then(null,function(i){return(i instanceof t?n:Ct)(i)}):this.then(null,function(i){return(i&&i.name===t?n:Ct)(i)})},finally:function(e){return this.then(function(t){return j.resolve(e()).then(function(){return t})},function(t){return j.resolve(e()).then(function(){return Ct(t)})})},timeout:function(e,t){var n=this;return e<1/0?new j(function(i,o){var a=setTimeout(function(){return o(new M.Timeout(t))},e);n.then(i,o).finally(clearTimeout.bind(null,a))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&ie(j.prototype,Symbol.toStringTag,"Dexie.Promise"),xe.env=mr(),X(j,{all:function(){var e=be.apply(null,arguments).map(At);return new j(function(t,n){e.length===0&&t([]);var i=e.length;e.forEach(function(o,a){return j.resolve(o).then(function(u){e[a]=u,--i||t(e)},n)})})},resolve:function(e){return e instanceof j?e:e&&typeof e.then=="function"?new j(function(t,n){e.then(t,n)}):new j(ut,!0,e)},reject:Ct,race:function(){var e=be.apply(null,arguments).map(At);return new j(function(t,n){e.map(function(i){return j.resolve(i).then(t,n)})})},PSD:{get:function(){return F},set:function(e){return F=e}},totalEchoes:{get:function(){return Tt}},newPSD:ke,usePSD:De,scheduler:{get:function(){return lt},set:function(e){lt=e}},rejectionMapper:{get:function(){return pn},set:function(e){pn=e}},follow:function(e,t){return new j(function(n,i){return ke(function(o,a){var u=F;u.unhandleds=[],u.onunhandled=a,u.finalize=Te(function(){var l,d=this;l=function(){d.unhandleds.length===0?o():a(d.unhandleds[0])},St.push(function p(){l(),St.splice(St.indexOf(p),1)}),++Be,lt(function(){--Be==0&&vn()},[])},u.finalize),e()},t,n,i)})}}),$e&&($e.allSettled&&ie(j,"allSettled",function(){var e=be.apply(null,arguments).map(At);return new j(function(t){e.length===0&&t([]);var n=e.length,i=new Array(n);e.forEach(function(o,a){return j.resolve(o).then(function(u){return i[a]={status:"fulfilled",value:u}},function(u){return i[a]={status:"rejected",reason:u}}).then(function(){return--n||t(i)})})})}),$e.any&&typeof AggregateError<"u"&&ie(j,"any",function(){var e=be.apply(null,arguments).map(At);return new j(function(t,n){e.length===0&&n(new AggregateError([]));var i=e.length,o=new Array(i);e.forEach(function(a,u){return j.resolve(a).then(function(l){return t(l)},function(l){o[u]=l,--i||n(new AggregateError(o))})})})}),$e.withResolvers&&(j.withResolvers=$e.withResolvers));var ne={awaits:0,echoes:0,id:0},xi=0,Pt=[],Kt=0,Tt=0,ki=0;function ke(e,t,n,i){var o=F,a=Object.create(o);return a.parent=o,a.ref=0,a.global=!1,a.id=++ki,xe.env,a.env=dn?{Promise:j,PromiseProp:{value:j,configurable:!0,writable:!0},all:j.all,race:j.race,allSettled:j.allSettled,any:j.any,resolve:j.resolve,reject:j.reject}:{},t&&T(a,t),++o.ref,a.finalize=function(){--this.parent.ref||this.parent.finalize()},i=De(a,e,n,i),a.ref===0&&a.finalize(),i}function Xe(){return ne.id||(ne.id=++xi),++ne.awaits,ne.echoes+=hr,ne.id}function Ee(){return!!ne.awaits&&(--ne.awaits==0&&(ne.id=0),ne.echoes=ne.awaits*hr,!0)}function At(e){return ne.echoes&&e&&e.constructor===$e?(Xe(),e.then(function(t){return Ee(),t},function(t){return Ee(),ee(t)})):e}function Ei(){var e=Pt[Pt.length-1];Pt.pop(),Oe(e,!1)}function Oe(e,t){var n,i=F;(t?!ne.echoes||Kt++&&e===F:!Kt||--Kt&&e===F)||queueMicrotask(t?(function(o){++Tt,ne.echoes&&--ne.echoes!=0||(ne.echoes=ne.awaits=ne.id=0),Pt.push(F),Oe(o,!0)}).bind(null,e):Ei),e!==F&&(F=e,i===xe&&(xe.env=mr()),dn&&(n=xe.env.Promise,t=e.env,(i.global||e.global)&&(Object.defineProperty(_,"Promise",t.PromiseProp),n.all=t.all,n.race=t.race,n.resolve=t.resolve,n.reject=t.reject,t.allSettled&&(n.allSettled=t.allSettled),t.any&&(n.any=t.any))))}function mr(){var e=_.Promise;return dn?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(_,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject}:{}}function De(e,t,n,i,o){var a=F;try{return Oe(e,!0),t(n,i,o)}finally{Oe(a,!1)}}function gr(e,t,n,i){return typeof e!="function"?e:function(){var o=F;n&&Xe(),Oe(t,!0);try{return e.apply(this,arguments)}finally{Oe(o,!1),i&&queueMicrotask(Ee)}}}function bn(e){Promise===$e&&ne.echoes===0?Kt===0?e():enqueueNativeMicroTask(e):setTimeout(e,0)}(""+de).indexOf("[native code]")===-1&&(Xe=Ee=Q);var ee=j.reject,je="ï¿¿",we="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",vr="String expected.",He=[],$t="__dbnames",wn="readonly",_n="readwrite";function Le(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var br={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Rt(e){return typeof e!="string"||/\./.test(e)?function(t){return t}:function(t){return t[e]===void 0&&e in t&&delete(t=Pe(t))[e],t}}function wr(){throw M.Type()}function V(e,t){try{var n=_r(e),i=_r(t);if(n!==i)return n==="Array"?1:i==="Array"?-1:n==="binary"?1:i==="binary"?-1:n==="string"?1:i==="string"?-1:n==="Date"?1:i!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return t<e?1:e<t?-1:0;case"binary":return function(o,a){for(var u=o.length,l=a.length,d=u<l?u:l,p=0;p<d;++p)if(o[p]!==a[p])return o[p]<a[p]?-1:1;return u===l?0:u<l?-1:1}(xr(e),xr(t));case"Array":return function(o,a){for(var u=o.length,l=a.length,d=u<l?u:l,p=0;p<d;++p){var v=V(o[p],a[p]);if(v!==0)return v}return u===l?0:u<l?-1:1}(e,t)}}catch{}return NaN}function _r(e){var t=typeof e;return t!="object"?t:ArrayBuffer.isView(e)?"binary":(e=sn(e),e==="ArrayBuffer"?"binary":e)}function xr(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var kr=(Z.prototype._trans=function(e,t,n){var i=this._tx||F.trans,o=this.name,a=he&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(e==="readonly"?"read":"write"," ").concat(this.name));function u(p,v,f){if(!f.schema[o])throw new M.NotFound("Table "+o+" not part of transaction");return t(f.idbtrans,f)}var l=Ye();try{var d=i&&i.db._novip===this.db._novip?i===F.trans?i._promise(e,u,n):ke(function(){return i._promise(e,u,n)},{trans:i,transless:F.transless||F}):function p(v,f,w,h){if(v.idbdb&&(v._state.openComplete||F.letThrough||v._vip)){var g=v._createTransaction(f,w,v._dbSchema);try{g.create(),v._state.PR1398_maxLoop=3}catch(b){return b.name===ln.InvalidState&&v.isOpen()&&0<--v._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),v.close({disableAutoOpen:!1}),v.open().then(function(){return p(v,f,w,h)})):ee(b)}return g._promise(f,function(b,y){return ke(function(){return F.trans=g,h(b,y,g)})}).then(function(b){if(f==="readwrite")try{g.idbtrans.commit()}catch{}return f==="readonly"?b:g._completion.then(function(){return b})})}if(v._state.openComplete)return ee(new M.DatabaseClosed(v._state.dbOpenError));if(!v._state.isBeingOpened){if(!v._state.autoOpen)return ee(new M.DatabaseClosed);v.open().catch(Q)}return v._state.dbReadyPromise.then(function(){return p(v,f,w,h)})}(this.db,e,[this.name],u);return a&&(d._consoleTask=a,d=d.catch(function(p){return console.trace(p),ee(p)})),d}finally{l&&Qe()}},Z.prototype.get=function(e,t){var n=this;return e&&e.constructor===Object?this.where(e).first(t):e==null?ee(new M.Type("Invalid argument to Table.get()")):this._trans("readonly",function(i){return n.core.get({trans:i,key:e}).then(function(o){return n.hook.reading.fire(o)})}).then(t)},Z.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(S(e))return new this.db.WhereClause(this,"[".concat(e.join("+"),"]"));var t=C(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var n=this.schema.indexes.concat(this.schema.primKey).filter(function(l){if(l.compound&&t.every(function(p){return 0<=l.keyPath.indexOf(p)})){for(var d=0;d<t.length;++d)if(t.indexOf(l.keyPath[d])===-1)return!1;return!0}return!1}).sort(function(l,d){return l.keyPath.length-d.keyPath.length})[0];if(n&&this.db._maxKey!==je){var a=n.keyPath.slice(0,t.length);return this.where(a).equals(a.map(function(d){return e[d]}))}!n&&he&&console.warn("The query ".concat(JSON.stringify(e)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(t.join("+"),"]"));var i=this.schema.idxByName;function o(l,d){return V(l,d)===0}var u=t.reduce(function(f,d){var p=f[0],v=f[1],f=i[d],w=e[d];return[p||f,p||!f?Le(v,f&&f.multi?function(h){return h=ve(h,d),S(h)&&h.some(function(g){return o(w,g)})}:function(h){return o(w,ve(h,d))}):v]},[null,null]),a=u[0],u=u[1];return a?this.where(a.name).equals(e[a.keyPath]).filter(u):n?this.filter(u):this.where(t).equals("")},Z.prototype.filter=function(e){return this.toCollection().and(e)},Z.prototype.count=function(e){return this.toCollection().count(e)},Z.prototype.offset=function(e){return this.toCollection().offset(e)},Z.prototype.limit=function(e){return this.toCollection().limit(e)},Z.prototype.each=function(e){return this.toCollection().each(e)},Z.prototype.toArray=function(e){return this.toCollection().toArray(e)},Z.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Z.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,S(e)?"[".concat(e.join("+"),"]"):e))},Z.prototype.reverse=function(){return this.toCollection().reverse()},Z.prototype.mapToClass=function(e){var t,n=this.db,i=this.name;function o(){return t!==null&&t.apply(this,arguments)||this}(this.schema.mappedClass=e).prototype instanceof wr&&(function(d,p){if(typeof p!="function"&&p!==null)throw new TypeError("Class extends value "+String(p)+" is not a constructor or null");function v(){this.constructor=d}s(d,p),d.prototype=p===null?Object.create(p):(v.prototype=p.prototype,new v)}(o,t=e),Object.defineProperty(o.prototype,"db",{get:function(){return n},enumerable:!1,configurable:!0}),o.prototype.table=function(){return i},e=o);for(var a=new Set,u=e.prototype;u;u=B(u))Object.getOwnPropertyNames(u).forEach(function(d){return a.add(d)});function l(d){if(!d)return d;var p,v=Object.create(e.prototype);for(p in d)if(!a.has(p))try{v[p]=d[p]}catch{}return v}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=l,this.hook("reading",l),e},Z.prototype.defineClass=function(){return this.mapToClass(function(e){T(this,e)})},Z.prototype.add=function(e,t){var n=this,i=this.schema.primKey,o=i.auto,a=i.keyPath,u=e;return a&&o&&(u=Rt(a)(e)),this._trans("readwrite",function(l){return n.core.mutate({trans:l,type:"add",keys:t!=null?[t]:null,values:[u]})}).then(function(l){return l.numFailures?j.reject(l.failures[0]):l.lastResult}).then(function(l){if(a)try{ce(e,a,l)}catch{}return l})},Z.prototype.update=function(e,t){return typeof e!="object"||S(e)?this.where(":id").equals(e).modify(t):(e=ve(e,this.schema.primKey.keyPath),e===void 0?ee(new M.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(e).modify(t))},Z.prototype.put=function(e,t){var n=this,i=this.schema.primKey,o=i.auto,a=i.keyPath,u=e;return a&&o&&(u=Rt(a)(e)),this._trans("readwrite",function(l){return n.core.mutate({trans:l,type:"put",values:[u],keys:t!=null?[t]:null})}).then(function(l){return l.numFailures?j.reject(l.failures[0]):l.lastResult}).then(function(l){if(a)try{ce(e,a,l)}catch{}return l})},Z.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(n){return t.core.mutate({trans:n,type:"delete",keys:[e]})}).then(function(n){return n.numFailures?j.reject(n.failures[0]):void 0})},Z.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:br})}).then(function(t){return t.numFailures?j.reject(t.failures[0]):void 0})},Z.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(n){return t.core.getMany({keys:e,trans:n}).then(function(i){return i.map(function(o){return t.hook.reading.fire(o)})})})},Z.prototype.bulkAdd=function(e,t,n){var i=this,o=Array.isArray(t)?t:void 0,a=(n=n||(o?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",function(u){var p=i.schema.primKey,l=p.auto,p=p.keyPath;if(p&&o)throw new M.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(o&&o.length!==e.length)throw new M.InvalidArgument("Arguments objects and keys must have the same length");var d=e.length,p=p&&l?e.map(Rt(p)):e;return i.core.mutate({trans:u,type:"add",keys:o,values:p,wantResults:a}).then(function(g){var f=g.numFailures,w=g.results,h=g.lastResult,g=g.failures;if(f===0)return a?w:h;throw new Ve("".concat(i.name,".bulkAdd(): ").concat(f," of ").concat(d," operations failed"),g)})})},Z.prototype.bulkPut=function(e,t,n){var i=this,o=Array.isArray(t)?t:void 0,a=(n=n||(o?void 0:t))?n.allKeys:void 0;return this._trans("readwrite",function(u){var p=i.schema.primKey,l=p.auto,p=p.keyPath;if(p&&o)throw new M.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(o&&o.length!==e.length)throw new M.InvalidArgument("Arguments objects and keys must have the same length");var d=e.length,p=p&&l?e.map(Rt(p)):e;return i.core.mutate({trans:u,type:"put",keys:o,values:p,wantResults:a}).then(function(g){var f=g.numFailures,w=g.results,h=g.lastResult,g=g.failures;if(f===0)return a?w:h;throw new Ve("".concat(i.name,".bulkPut(): ").concat(f," of ").concat(d," operations failed"),g)})})},Z.prototype.bulkUpdate=function(e){var t=this,n=this.core,i=e.map(function(u){return u.key}),o=e.map(function(u){return u.changes}),a=[];return this._trans("readwrite",function(u){return n.getMany({trans:u,keys:i,cache:"clone"}).then(function(l){var d=[],p=[];e.forEach(function(f,w){var h=f.key,g=f.changes,b=l[w];if(b){for(var y=0,x=Object.keys(g);y<x.length;y++){var E=x[y],O=g[E];if(E===t.schema.primKey.keyPath){if(V(O,h)!==0)throw new M.Constraint("Cannot update primary key in bulkUpdate()")}else ce(b,E,O)}a.push(w),d.push(h),p.push(b)}});var v=d.length;return n.mutate({trans:u,type:"put",keys:d,values:p,updates:{keys:i,changeSpecs:o}}).then(function(f){var w=f.numFailures,h=f.failures;if(w===0)return v;for(var g=0,b=Object.keys(h);g<b.length;g++){var y,x=b[g],E=a[Number(x)];E!=null&&(y=h[x],delete h[x],h[E]=y)}throw new Ve("".concat(t.name,".bulkUpdate(): ").concat(w," of ").concat(v," operations failed"),h)})})})},Z.prototype.bulkDelete=function(e){var t=this,n=e.length;return this._trans("readwrite",function(i){return t.core.mutate({trans:i,type:"delete",keys:e})}).then(function(u){var o=u.numFailures,a=u.lastResult,u=u.failures;if(o===0)return a;throw new Ve("".concat(t.name,".bulkDelete(): ").concat(o," of ").concat(n," operations failed"),u)})},Z);function Z(){}function dt(e){function t(u,l){if(l){for(var d=arguments.length,p=new Array(d-1);--d;)p[d-1]=arguments[d];return n[u].subscribe.apply(null,p),e}if(typeof u=="string")return n[u]}var n={};t.addEventType=a;for(var i=1,o=arguments.length;i<o;++i)a(arguments[i]);return t;function a(u,l,d){if(typeof u!="object"){var p;l=l||bi;var v={subscribers:[],fire:d=d||Q,subscribe:function(f){v.subscribers.indexOf(f)===-1&&(v.subscribers.push(f),v.fire=l(v.fire,f))},unsubscribe:function(f){v.subscribers=v.subscribers.filter(function(w){return w!==f}),v.fire=v.subscribers.reduce(l,d)}};return n[u]=t[u]=v}C(p=u).forEach(function(f){var w=p[f];if(S(w))a(f,p[f][0],p[f][1]);else{if(w!=="asap")throw new M.InvalidArgument("Invalid event config");var h=a(f,st,function(){for(var g=arguments.length,b=new Array(g);g--;)b[g]=arguments[g];h.subscribers.forEach(function(y){ar(function(){y.apply(null,b)})})})}})}}function ht(e,t){return ge(t).from({prototype:e}),t}function Ze(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function xn(e,t){e.filter=Le(e.filter,t)}function kn(e,t,n){var i=e.replayFilter;e.replayFilter=i?function(){return Le(i(),t())}:t,e.justLimit=n&&!i}function Bt(e,t){if(e.isPrimKey)return t.primaryKey;var n=t.getIndexByKeyPath(e.index);if(!n)throw new M.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return n}function Er(e,t,n){var i=Bt(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:i,range:e.range}})}function Dt(e,t,n,i){var o=e.replayFilter?Le(e.filter,e.replayFilter()):e.filter;if(e.or){var a={},u=function(l,d,p){var v,f;o&&!o(d,p,function(w){return d.stop(w)},function(w){return d.fail(w)})||((f=""+(v=d.primaryKey))=="[object ArrayBuffer]"&&(f=""+new Uint8Array(v)),q(a,f)||(a[f]=!0,t(l,d,p)))};return Promise.all([e.or._iterate(u,n),Or(Er(e,i,n),e.algorithm,u,!e.keysOnly&&e.valueMapper)])}return Or(Er(e,i,n),Le(e.algorithm,o),t,!e.keysOnly&&e.valueMapper)}function Or(e,t,n,i){var o=J(i?function(a,u,l){return n(i(a),u,l)}:n);return e.then(function(a){if(a)return a.start(function(){var u=function(){return a.continue()};t&&!t(a,function(l){return u=l},function(l){a.stop(l),u=Q},function(l){a.fail(l),u=Q})||o(a.value,a,function(l){return u=l}),u()})})}var pt=(Ir.prototype.execute=function(e){var t=this["@@propmod"];if(t.add!==void 0){var n=t.add;if(S(n))return m(m([],S(e)?e:[],!0),n).sort();if(typeof n=="number")return(Number(e)||0)+n;if(typeof n=="bigint")try{return BigInt(e)+n}catch{return BigInt(0)+n}throw new TypeError("Invalid term ".concat(n))}if(t.remove!==void 0){var i=t.remove;if(S(i))return S(e)?e.filter(function(o){return!i.includes(o)}).sort():[];if(typeof i=="number")return Number(e)-i;if(typeof i=="bigint")try{return BigInt(e)-i}catch{return BigInt(0)-i}throw new TypeError("Invalid subtrahend ".concat(i))}return n=(n=t.replacePrefix)===null||n===void 0?void 0:n[0],n&&typeof e=="string"&&e.startsWith(n)?t.replacePrefix[1]+e.substring(n.length):e},Ir);function Ir(e){this["@@propmod"]=e}var Oi=(Y.prototype._read=function(e,t){var n=this._ctx;return n.error?n.table._trans(null,ee.bind(null,n.error)):n.table._trans("readonly",e).then(t)},Y.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,ee.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},Y.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=Le(t.algorithm,e)},Y.prototype._iterate=function(e,t){return Dt(this._ctx,e,t,this._ctx.table.core)},Y.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return e&&T(n,e),t._ctx=n,t},Y.prototype.raw=function(){return this._ctx.valueMapper=null,this},Y.prototype.each=function(e){var t=this._ctx;return this._read(function(n){return Dt(t,e,n,t.table.core)})},Y.prototype.count=function(e){var t=this;return this._read(function(n){var i=t._ctx,o=i.table.core;if(Ze(i,!0))return o.count({trans:n,query:{index:Bt(i,o.schema),range:i.range}}).then(function(u){return Math.min(u,i.limit)});var a=0;return Dt(i,function(){return++a,!1},n,o).then(function(){return a})}).then(e)},Y.prototype.sortBy=function(e,t){var n=e.split(".").reverse(),i=n[0],o=n.length-1;function a(d,p){return p?a(d[n[p]],p-1):d[i]}var u=this._ctx.dir==="next"?1:-1;function l(d,p){return V(a(d,o),a(p,o))*u}return this.toArray(function(d){return d.sort(l)}).then(t)},Y.prototype.toArray=function(e){var t=this;return this._read(function(n){var i=t._ctx;if(i.dir==="next"&&Ze(i,!0)&&0<i.limit){var o=i.valueMapper,a=Bt(i,i.table.core.schema);return i.table.core.query({trans:n,limit:i.limit,values:!0,query:{index:a,range:i.range}}).then(function(l){return l=l.result,o?l.map(o):l})}var u=[];return Dt(i,function(l){return u.push(l)},n,i.table.core).then(function(){return u})},e)},Y.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,Ze(t)?kn(t,function(){var n=e;return function(i,o){return n===0||(n===1?--n:o(function(){i.advance(n),n=0}),!1)}}):kn(t,function(){var n=e;return function(){return--n<0}})),this},Y.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),kn(this._ctx,function(){var t=e;return function(n,i,o){return--t<=0&&i(o),0<=t}},!0),this},Y.prototype.until=function(e,t){return xn(this._ctx,function(n,i,o){return!e(n.value)||(i(o),t)}),this},Y.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},Y.prototype.last=function(e){return this.reverse().first(e)},Y.prototype.filter=function(e){var t;return xn(this._ctx,function(n){return e(n.value)}),(t=this._ctx).isMatch=Le(t.isMatch,e),this},Y.prototype.and=function(e){return this.filter(e)},Y.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},Y.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Y.prototype.desc=function(){return this.reverse()},Y.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(n,i){e(i.key,i)})},Y.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},Y.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(n,i){e(i.primaryKey,i)})},Y.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var n=[];return this.each(function(i,o){n.push(o.key)}).then(function(){return n}).then(e)},Y.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&Ze(t,!0)&&0<t.limit)return this._read(function(i){var o=Bt(t,t.table.core.schema);return t.table.core.query({trans:i,values:!1,limit:t.limit,query:{index:o,range:t.range}})}).then(function(i){return i.result}).then(e);t.keysOnly=!t.isMatch;var n=[];return this.each(function(i,o){n.push(o.primaryKey)}).then(function(){return n}).then(e)},Y.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},Y.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},Y.prototype.lastKey=function(e){return this.reverse().firstKey(e)},Y.prototype.distinct=function(){var e=this._ctx,e=e.index&&e.table.schema.idxByName[e.index];if(!e||!e.multi)return this;var t={};return xn(this._ctx,function(o){var i=o.primaryKey.toString(),o=q(t,i);return t[i]=!0,!o}),this},Y.prototype.modify=function(e){var t=this,n=this._ctx;return this._write(function(i){var o,a,u;u=typeof e=="function"?e:(o=C(e),a=o.length,function(y){for(var x=!1,E=0;E<a;++E){var O=o[E],I=e[O],P=ve(y,O);I instanceof pt?(ce(y,O,I.execute(P)),x=!0):P!==I&&(ce(y,O,I),x=!0)}return x});var l=n.table.core,f=l.schema.primaryKey,d=f.outbound,p=f.extractKey,v=200,f=t.db._options.modifyChunkSize;f&&(v=typeof f=="object"?f[l.name]||f["*"]||200:f);function w(y,O){var E=O.failures,O=O.numFailures;g+=y-O;for(var I=0,P=C(E);I<P.length;I++){var R=P[I];h.push(E[R])}}var h=[],g=0,b=[];return t.clone().primaryKeys().then(function(y){function x(O){var I=Math.min(v,y.length-O);return l.getMany({trans:i,keys:y.slice(O,O+I),cache:"immutable"}).then(function(P){for(var R=[],K=[],A=d?[]:null,D=[],$=0;$<I;++$){var L=P[$],U={value:Pe(L),primKey:y[O+$]};u.call(U,U.value,U)!==!1&&(U.value==null?D.push(y[O+$]):d||V(p(L),p(U.value))===0?(K.push(U.value),d&&A.push(y[O+$])):(D.push(y[O+$]),R.push(U.value)))}return Promise.resolve(0<R.length&&l.mutate({trans:i,type:"add",values:R}).then(function(W){for(var z in W.failures)D.splice(parseInt(z),1);w(R.length,W)})).then(function(){return(0<K.length||E&&typeof e=="object")&&l.mutate({trans:i,type:"put",keys:A,values:K,criteria:E,changeSpec:typeof e!="function"&&e,isAdditionalChunk:0<O}).then(function(W){return w(K.length,W)})}).then(function(){return(0<D.length||E&&e===En)&&l.mutate({trans:i,type:"delete",keys:D,criteria:E,isAdditionalChunk:0<O}).then(function(W){return w(D.length,W)})}).then(function(){return y.length>O+I&&x(O+v)})})}var E=Ze(n)&&n.limit===1/0&&(typeof e!="function"||e===En)&&{index:n.index,range:n.range};return x(0).then(function(){if(0<h.length)throw new kt("Error modifying one or more objects",h,g,b);return y.length})})})},Y.prototype.delete=function(){var e=this._ctx,t=e.range;return Ze(e)&&(e.isPrimKey||t.type===3)?this._write(function(n){var i=e.table.core.schema.primaryKey,o=t;return e.table.core.count({trans:n,query:{index:i,range:o}}).then(function(a){return e.table.core.mutate({trans:n,type:"deleteRange",range:o}).then(function(u){var l=u.failures;if(u.lastResult,u.results,u=u.numFailures,u)throw new kt("Could not delete some values",Object.keys(l).map(function(d){return l[d]}),a-u);return a-u})})}):this.modify(En)},Y);function Y(){}var En=function(e,t){return t.value=null};function Ii(e,t){return e<t?-1:e===t?0:1}function Si(e,t){return t<e?-1:e===t?0:1}function le(e,t,n){return e=e instanceof Cr?new e.Collection(e):e,e._ctx.error=new(n||TypeError)(t),e}function Je(e){return new e.Collection(e,function(){return Sr("")}).limit(0)}function jt(e,t,n,i){var o,a,u,l,d,p,v,f=n.length;if(!n.every(function(g){return typeof g=="string"}))return le(e,vr);function w(g){o=g==="next"?function(y){return y.toUpperCase()}:function(y){return y.toLowerCase()},a=g==="next"?function(y){return y.toLowerCase()}:function(y){return y.toUpperCase()},u=g==="next"?Ii:Si;var b=n.map(function(y){return{lower:a(y),upper:o(y)}}).sort(function(y,x){return u(y.lower,x.lower)});l=b.map(function(y){return y.upper}),d=b.map(function(y){return y.lower}),v=(p=g)==="next"?"":i}w("next"),e=new e.Collection(e,function(){return Ie(l[0],d[f-1]+i)}),e._ondirectionchange=function(g){w(g)};var h=0;return e._addAlgorithm(function(g,b,y){var x=g.key;if(typeof x!="string")return!1;var E=a(x);if(t(E,d,h))return!0;for(var O=null,I=h;I<f;++I){var P=function(R,K,A,D,$,L){for(var U=Math.min(R.length,D.length),W=-1,z=0;z<U;++z){var fe=K[z];if(fe!==D[z])return $(R[z],A[z])<0?R.substr(0,z)+A[z]+A.substr(z+1):$(R[z],D[z])<0?R.substr(0,z)+D[z]+A.substr(z+1):0<=W?R.substr(0,W)+K[W]+A.substr(W+1):null;$(R[z],fe)<0&&(W=z)}return U<D.length&&L==="next"?R+A.substr(R.length):U<R.length&&L==="prev"?R.substr(0,A.length):W<0?null:R.substr(0,W)+D[W]+A.substr(W+1)}(x,E,l[I],d[I],u,p);P===null&&O===null?h=I+1:(O===null||0<u(O,P))&&(O=P)}return b(O!==null?function(){g.continue(O+v)}:y),!1}),e}function Ie(e,t,n,i){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:i}}function Sr(e){return{type:1,lower:e,upper:e}}var Cr=(Object.defineProperty(re.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),re.prototype.between=function(e,t,n,i){n=n!==!1,i=i===!0;try{return 0<this._cmp(e,t)||this._cmp(e,t)===0&&(n||i)&&(!n||!i)?Je(this):new this.Collection(this,function(){return Ie(e,t,!n,!i)})}catch{return le(this,we)}},re.prototype.equals=function(e){return e==null?le(this,we):new this.Collection(this,function(){return Sr(e)})},re.prototype.above=function(e){return e==null?le(this,we):new this.Collection(this,function(){return Ie(e,void 0,!0)})},re.prototype.aboveOrEqual=function(e){return e==null?le(this,we):new this.Collection(this,function(){return Ie(e,void 0,!1)})},re.prototype.below=function(e){return e==null?le(this,we):new this.Collection(this,function(){return Ie(void 0,e,!1,!0)})},re.prototype.belowOrEqual=function(e){return e==null?le(this,we):new this.Collection(this,function(){return Ie(void 0,e)})},re.prototype.startsWith=function(e){return typeof e!="string"?le(this,vr):this.between(e,e+je,!0,!0)},re.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):jt(this,function(t,n){return t.indexOf(n[0])===0},[e],je)},re.prototype.equalsIgnoreCase=function(e){return jt(this,function(t,n){return t===n[0]},[e],"")},re.prototype.anyOfIgnoreCase=function(){var e=be.apply(We,arguments);return e.length===0?Je(this):jt(this,function(t,n){return n.indexOf(t)!==-1},e,"")},re.prototype.startsWithAnyOfIgnoreCase=function(){var e=be.apply(We,arguments);return e.length===0?Je(this):jt(this,function(t,n){return n.some(function(i){return t.indexOf(i)===0})},e,je)},re.prototype.anyOf=function(){var e=this,t=be.apply(We,arguments),n=this._cmp;try{t.sort(n)}catch{return le(this,we)}if(t.length===0)return Je(this);var i=new this.Collection(this,function(){return Ie(t[0],t[t.length-1])});i._ondirectionchange=function(a){n=a==="next"?e._ascending:e._descending,t.sort(n)};var o=0;return i._addAlgorithm(function(a,u,l){for(var d=a.key;0<n(d,t[o]);)if(++o===t.length)return u(l),!1;return n(d,t[o])===0||(u(function(){a.continue(t[o])}),!1)}),i},re.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},re.prototype.noneOf=function(){var e=be.apply(We,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return le(this,we)}var t=e.reduce(function(n,i){return n?n.concat([[n[n.length-1][1],i]]):[[-1/0,i]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},re.prototype.inAnyRange=function(x,t){var n=this,i=this._cmp,o=this._ascending,a=this._descending,u=this._min,l=this._max;if(x.length===0)return Je(this);if(!x.every(function(E){return E[0]!==void 0&&E[1]!==void 0&&o(E[0],E[1])<=0}))return le(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",M.InvalidArgument);var d=!t||t.includeLowers!==!1,p=t&&t.includeUppers===!0,v,f=o;function w(E,O){return f(E[0],O[0])}try{(v=x.reduce(function(E,O){for(var I=0,P=E.length;I<P;++I){var R=E[I];if(i(O[0],R[1])<0&&0<i(O[1],R[0])){R[0]=u(R[0],O[0]),R[1]=l(R[1],O[1]);break}}return I===P&&E.push(O),E},[])).sort(w)}catch{return le(this,we)}var h=0,g=p?function(E){return 0<o(E,v[h][1])}:function(E){return 0<=o(E,v[h][1])},b=d?function(E){return 0<a(E,v[h][0])}:function(E){return 0<=a(E,v[h][0])},y=g,x=new this.Collection(this,function(){return Ie(v[0][0],v[v.length-1][1],!d,!p)});return x._ondirectionchange=function(E){f=E==="next"?(y=g,o):(y=b,a),v.sort(w)},x._addAlgorithm(function(E,O,I){for(var P,R=E.key;y(R);)if(++h===v.length)return O(I),!1;return!g(P=R)&&!b(P)||(n._cmp(R,v[h][1])===0||n._cmp(R,v[h][0])===0||O(function(){f===o?E.continue(v[h][0]):E.continue(v[h][1])}),!1)}),x},re.prototype.startsWithAnyOf=function(){var e=be.apply(We,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?Je(this):this.inAnyRange(e.map(function(t){return[t,t+je]})):le(this,"startsWithAnyOf() only works with strings")},re);function re(){}function pe(e){return J(function(t){return yt(t),e(t.target.error),!1})}function yt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var mt="storagemutated",On="x-storagemutated-1",Se=dt(null,mt),Ci=(ye.prototype._lock=function(){return ot(!F.global),++this._reculock,this._reculock!==1||F.global||(F.lockOwnerFor=this),this},ye.prototype._unlock=function(){if(ot(!F.global),--this._reculock==0)for(F.global||(F.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var e=this._blockedFuncs.shift();try{De(e[1],e[0])}catch{}}return this},ye.prototype._locked=function(){return this._reculock&&F.lockOwnerFor!==this},ye.prototype.create=function(e){var t=this;if(!this.mode)return this;var n=this.db.idbdb,i=this.db._state.dbOpenError;if(ot(!this.idbtrans),!e&&!n)switch(i&&i.name){case"DatabaseClosedError":throw new M.DatabaseClosed(i);case"MissingAPIError":throw new M.MissingAPI(i.message,i);default:throw new M.OpenFailed(i)}if(!this.active)throw new M.TransactionInactive;return ot(this._completion._state===null),(e=this.idbtrans=e||(this.db.core||n).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=J(function(o){yt(o),t._reject(e.error)}),e.onabort=J(function(o){yt(o),t.active&&t._reject(new M.Abort(e.error)),t.active=!1,t.on("abort").fire(o)}),e.oncomplete=J(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&Se.storagemutated.fire(e.mutatedParts)}),this},ye.prototype._promise=function(e,t,n){var i=this;if(e==="readwrite"&&this.mode!=="readwrite")return ee(new M.ReadOnly("Transaction is readonly"));if(!this.active)return ee(new M.TransactionInactive);if(this._locked())return new j(function(a,u){i._blockedFuncs.push([function(){i._promise(e,t,n).then(a,u)},F])});if(n)return ke(function(){var a=new j(function(u,l){i._lock();var d=t(u,l,i);d&&d.then&&d.then(u,l)});return a.finally(function(){return i._unlock()}),a._lib=!0,a});var o=new j(function(a,u){var l=t(a,u,i);l&&l.then&&l.then(a,u)});return o._lib=!0,o},ye.prototype._root=function(){return this.parent?this.parent._root():this},ye.prototype.waitFor=function(e){var t,n=this._root(),i=j.resolve(e);n._waitingFor?n._waitingFor=n._waitingFor.then(function(){return i}):(n._waitingFor=i,n._waitingQueue=[],t=n.idbtrans.objectStore(n.storeNames[0]),function a(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(t.get(-1/0).onsuccess=a)}());var o=n._waitingFor;return new j(function(a,u){i.then(function(l){return n._waitingQueue.push(J(a.bind(null,l)))},function(l){return n._waitingQueue.push(J(u.bind(null,l)))}).finally(function(){n._waitingFor===o&&(n._waitingFor=null)})})},ye.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new M.Abort))},ye.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(q(t,e))return t[e];var n=this.schema[e];if(!n)throw new M.NotFound("Table "+e+" not part of transaction");return n=new this.db.Table(e,n,this),n.core=this.db.core.table(e),t[e]=n},ye);function ye(){}function In(e,t,n,i,o,a,u){return{name:e,keyPath:t,unique:n,multi:i,auto:o,compound:a,src:(n&&!u?"&":"")+(i?"*":"")+(o?"++":"")+Pr(t)}}function Pr(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Sn(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:(i=function(o){return[o.name,o]},n.reduce(function(o,a,u){return u=i(a,u),u&&(o[u[0]]=u[1]),o},{}))};var i}var gt=function(e){try{return e.only([[]]),gt=function(){return[[]]},[[]]}catch{return gt=function(){return je},je}};function Cn(e){return e==null?function(){}:typeof e=="string"?(t=e).split(".").length===1?function(n){return n[t]}:function(n){return ve(n,t)}:function(n){return ve(n,e)};var t}function Kr(e){return[].slice.call(e)}var Pi=0;function vt(e){return e==null?":id":typeof e=="string"?e:"[".concat(e.join("+"),"]")}function Ki(e,t,d){function i(y){if(y.type===3)return null;if(y.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var h=y.lower,g=y.upper,b=y.lowerOpen,y=y.upperOpen;return h===void 0?g===void 0?null:t.upperBound(g,!!y):g===void 0?t.lowerBound(h,!!b):t.bound(h,g,!!b,!!y)}function o(w){var h,g=w.name;return{name:g,schema:w,mutate:function(b){var y=b.trans,x=b.type,E=b.keys,O=b.values,I=b.range;return new Promise(function(P,R){P=J(P);var K=y.objectStore(g),A=K.keyPath==null,D=x==="put"||x==="add";if(!D&&x!=="delete"&&x!=="deleteRange")throw new Error("Invalid operation type: "+x);var $,L=(E||O||{length:1}).length;if(E&&O&&E.length!==O.length)throw new Error("Given keys array must have same length as given values array.");if(L===0)return P({numFailures:0,failures:{},results:[],lastResult:void 0});function U(ue){++fe,yt(ue)}var W=[],z=[],fe=0;if(x==="deleteRange"){if(I.type===4)return P({numFailures:fe,failures:z,results:[],lastResult:void 0});I.type===3?W.push($=K.clear()):W.push($=K.delete(i(I)))}else{var A=D?A?[O,E]:[O,null]:[E,null],G=A[0],ae=A[1];if(D)for(var se=0;se<L;++se)W.push($=ae&&ae[se]!==void 0?K[x](G[se],ae[se]):K[x](G[se])),$.onerror=U;else for(se=0;se<L;++se)W.push($=K[x](G[se])),$.onerror=U}function Xt(ue){ue=ue.target.result,W.forEach(function(Fe,zn){return Fe.error!=null&&(z[zn]=Fe.error)}),P({numFailures:fe,failures:z,results:x==="delete"?E:W.map(function(Fe){return Fe.result}),lastResult:ue})}$.onerror=function(ue){U(ue),Xt(ue)},$.onsuccess=Xt})},getMany:function(b){var y=b.trans,x=b.keys;return new Promise(function(E,O){E=J(E);for(var I,P=y.objectStore(g),R=x.length,K=new Array(R),A=0,D=0,$=function(W){W=W.target,K[W._pos]=W.result,++D===A&&E(K)},L=pe(O),U=0;U<R;++U)x[U]!=null&&((I=P.get(x[U]))._pos=U,I.onsuccess=$,I.onerror=L,++A);A===0&&E(K)})},get:function(b){var y=b.trans,x=b.key;return new Promise(function(E,O){E=J(E);var I=y.objectStore(g).get(x);I.onsuccess=function(P){return E(P.target.result)},I.onerror=pe(O)})},query:(h=p,function(b){return new Promise(function(y,x){y=J(y);var E,O,I,A=b.trans,P=b.values,R=b.limit,$=b.query,K=R===1/0?void 0:R,D=$.index,$=$.range,A=A.objectStore(g),D=D.isPrimaryKey?A:A.index(D.name),$=i($);if(R===0)return y({result:[]});h?((K=P?D.getAll($,K):D.getAllKeys($,K)).onsuccess=function(L){return y({result:L.target.result})},K.onerror=pe(x)):(E=0,O=!P&&"openKeyCursor"in D?D.openKeyCursor($):D.openCursor($),I=[],O.onsuccess=function(L){var U=O.result;return U?(I.push(P?U.value:U.primaryKey),++E===R?y({result:I}):void U.continue()):y({result:I})},O.onerror=pe(x))})}),openCursor:function(b){var y=b.trans,x=b.values,E=b.query,O=b.reverse,I=b.unique;return new Promise(function(P,R){P=J(P);var D=E.index,K=E.range,A=y.objectStore(g),A=D.isPrimaryKey?A:A.index(D.name),D=O?I?"prevunique":"prev":I?"nextunique":"next",$=!x&&"openKeyCursor"in A?A.openKeyCursor(i(K),D):A.openCursor(i(K),D);$.onerror=pe(R),$.onsuccess=J(function(L){var U,W,z,fe,G=$.result;G?(G.___id=++Pi,G.done=!1,U=G.continue.bind(G),W=(W=G.continuePrimaryKey)&&W.bind(G),z=G.advance.bind(G),fe=function(){throw new Error("Cursor not stopped")},G.trans=y,G.stop=G.continue=G.continuePrimaryKey=G.advance=function(){throw new Error("Cursor not started")},G.fail=J(R),G.next=function(){var ae=this,se=1;return this.start(function(){return se--?ae.continue():ae.stop()}).then(function(){return ae})},G.start=function(ae){function se(){if($.result)try{ae()}catch(ue){G.fail(ue)}else G.done=!0,G.start=function(){throw new Error("Cursor behind last entry")},G.stop()}var Xt=new Promise(function(ue,Fe){ue=J(ue),$.onerror=pe(Fe),G.fail=Fe,G.stop=function(zn){G.stop=G.continue=G.continuePrimaryKey=G.advance=fe,ue(zn)}});return $.onsuccess=J(function(ue){$.onsuccess=se,se()}),G.continue=U,G.continuePrimaryKey=W,G.advance=z,se(),Xt},P(G)):P(null)},R)})},count:function(b){var y=b.query,x=b.trans,E=y.index,O=y.range;return new Promise(function(I,P){var R=x.objectStore(g),K=E.isPrimaryKey?R:R.index(E.name),R=i(O),K=R?K.count(R):K.count();K.onsuccess=J(function(A){return I(A.target.result)}),K.onerror=pe(P)})}}}var a,u,l,v=(u=d,l=Kr((a=e).objectStoreNames),{schema:{name:a.name,tables:l.map(function(w){return u.objectStore(w)}).map(function(w){var h=w.keyPath,y=w.autoIncrement,g=S(h),b={},y={name:w.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:h==null,compound:g,keyPath:h,autoIncrement:y,unique:!0,extractKey:Cn(h)},indexes:Kr(w.indexNames).map(function(x){return w.index(x)}).map(function(I){var E=I.name,O=I.unique,P=I.multiEntry,I=I.keyPath,P={name:E,compound:S(I),keyPath:I,unique:O,multiEntry:P,extractKey:Cn(I)};return b[vt(I)]=P}),getIndexByKeyPath:function(x){return b[vt(x)]}};return b[":id"]=y.primaryKey,h!=null&&(b[vt(h)]=y.primaryKey),y})},hasGetAll:0<l.length&&"getAll"in u.objectStore(l[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),d=v.schema,p=v.hasGetAll,v=d.tables.map(o),f={};return v.forEach(function(w){return f[w.name]=w}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(w){if(!f[w])throw new Error("Table '".concat(w,"' not found"));return f[w]},MIN_KEY:-1/0,MAX_KEY:gt(t),schema:d}}function Ti(e,t,n,i){var o=n.IDBKeyRange;return n.indexedDB,{dbcore:(i=Ki(t,o,i),e.dbcore.reduce(function(a,u){return u=u.create,c(c({},a),u(a))},i))}}function Lt(e,i){var n=i.db,i=Ti(e._middlewares,n,e._deps,i);e.core=i.dbcore,e.tables.forEach(function(o){var a=o.name;e.core.schema.tables.some(function(u){return u.name===a})&&(o.core=e.core.table(a),e[a]instanceof e.Table&&(e[a].core=o.core))})}function qt(e,t,n,i){n.forEach(function(o){var a=i[o];t.forEach(function(u){var l=function d(p,v){return an(p,v)||(p=B(p))&&d(p,v)}(u,o);(!l||"value"in l&&l.value===void 0)&&(u===e.Transaction.prototype||u instanceof e.Transaction?ie(u,o,{get:function(){return this.table(o)},set:function(d){H(this,o,{value:d,writable:!0,configurable:!0,enumerable:!0})}}):u[o]=new e.Table(o,a))})})}function Pn(e,t){t.forEach(function(n){for(var i in n)n[i]instanceof e.Table&&delete n[i]})}function Ai(e,t){return e._cfg.version-t._cfg.version}function $i(e,t,n,i){var o=e._dbSchema;n.objectStoreNames.contains("$meta")&&!o.$meta&&(o.$meta=Sn("$meta",Ar("")[0],[]),e._storeNames.push("$meta"));var a=e._createTransaction("readwrite",e._storeNames,o);a.create(n),a._completion.catch(i);var u=a._reject.bind(a),l=F.transless||F;ke(function(){return F.trans=a,F.transless=l,t!==0?(Lt(e,n),p=t,((d=a).storeNames.includes("$meta")?d.table("$meta").get("version").then(function(v){return v??p}):j.resolve(p)).then(function(v){return w=v,h=a,g=n,b=[],v=(f=e)._versions,y=f._dbSchema=Ft(0,f.idbdb,g),(v=v.filter(function(x){return x._cfg.version>=w})).length!==0?(v.forEach(function(x){b.push(function(){var E=y,O=x._cfg.dbschema;Mt(f,E,g),Mt(f,O,g),y=f._dbSchema=O;var I=Kn(E,O);I.add.forEach(function(D){Tn(g,D[0],D[1].primKey,D[1].indexes)}),I.change.forEach(function(D){if(D.recreate)throw new M.Upgrade("Not yet support for changing primary key");var $=g.objectStore(D.name);D.add.forEach(function(L){return Nt($,L)}),D.change.forEach(function(L){$.deleteIndex(L.name),Nt($,L)}),D.del.forEach(function(L){return $.deleteIndex(L)})});var P=x._cfg.contentUpgrade;if(P&&x._cfg.version>w){Lt(f,g),h._memoizedTables={};var R=sr(O);I.del.forEach(function(D){R[D]=E[D]}),Pn(f,[f.Transaction.prototype]),qt(f,[f.Transaction.prototype],C(R),R),h.schema=R;var K,A=cn(P);return A&&Xe(),I=j.follow(function(){var D;(K=P(h))&&A&&(D=Ee.bind(null,null),K.then(D,D))}),K&&typeof K.then=="function"?j.resolve(K):I.then(function(){return K})}}),b.push(function(E){var O,I,P=x._cfg.dbschema;O=P,I=E,[].slice.call(I.db.objectStoreNames).forEach(function(R){return O[R]==null&&I.db.deleteObjectStore(R)}),Pn(f,[f.Transaction.prototype]),qt(f,[f.Transaction.prototype],f._storeNames,f._dbSchema),h.schema=f._dbSchema}),b.push(function(E){f.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(f.idbdb.version/10)===x._cfg.version?(f.idbdb.deleteObjectStore("$meta"),delete f._dbSchema.$meta,f._storeNames=f._storeNames.filter(function(O){return O!=="$meta"})):E.objectStore("$meta").put(x._cfg.version,"version"))})}),function x(){return b.length?j.resolve(b.shift()(h.idbtrans)).then(x):j.resolve()}().then(function(){Tr(y,g)})):j.resolve();var f,w,h,g,b,y}).catch(u)):(C(o).forEach(function(v){Tn(n,v,o[v].primKey,o[v].indexes)}),Lt(e,n),void j.follow(function(){return e.on.populate.fire(a)}).catch(u));var d,p})}function Ri(e,t){Tr(e._dbSchema,t),t.db.version%10!=0||t.objectStoreNames.contains("$meta")||t.db.createObjectStore("$meta").add(Math.ceil(t.db.version/10-1),"version");var n=Ft(0,e.idbdb,t);Mt(e,e._dbSchema,t);for(var i=0,o=Kn(n,e._dbSchema).change;i<o.length;i++){var a=function(u){if(u.change.length||u.recreate)return console.warn("Unable to patch indexes of table ".concat(u.name," because it has changes on the type of index or primary key.")),{value:void 0};var l=t.objectStore(u.name);u.add.forEach(function(d){he&&console.debug("Dexie upgrade patch: Creating missing index ".concat(u.name,".").concat(d.src)),Nt(l,d)})}(o[i]);if(typeof a=="object")return a.value}}function Kn(e,t){var n,i={del:[],add:[],change:[]};for(n in e)t[n]||i.del.push(n);for(n in t){var o=e[n],a=t[n];if(o){var u={name:n,def:a,recreate:!1,del:[],add:[],change:[]};if(""+(o.primKey.keyPath||"")!=""+(a.primKey.keyPath||"")||o.primKey.auto!==a.primKey.auto)u.recreate=!0,i.change.push(u);else{var l=o.idxByName,d=a.idxByName,p=void 0;for(p in l)d[p]||u.del.push(p);for(p in d){var v=l[p],f=d[p];v?v.src!==f.src&&u.change.push(f):u.add.push(f)}(0<u.del.length||0<u.add.length||0<u.change.length)&&i.change.push(u)}}else i.add.push([n,a])}return i}function Tn(e,t,n,i){var o=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return i.forEach(function(a){return Nt(o,a)}),o}function Tr(e,t){C(e).forEach(function(n){t.db.objectStoreNames.contains(n)||(he&&console.debug("Dexie: Creating missing table",n),Tn(t,n,e[n].primKey,e[n].indexes))})}function Nt(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function Ft(e,t,n){var i={};return xt(t.objectStoreNames,0).forEach(function(o){for(var a=n.objectStore(o),u=In(Pr(p=a.keyPath),p||"",!0,!1,!!a.autoIncrement,p&&typeof p!="string",!0),l=[],d=0;d<a.indexNames.length;++d){var v=a.index(a.indexNames[d]),p=v.keyPath,v=In(v.name,p,!!v.unique,!!v.multiEntry,!1,p&&typeof p!="string",!1);l.push(v)}i[o]=Sn(o,u,l)}),i}function Mt(e,t,n){for(var i=n.db.objectStoreNames,o=0;o<i.length;++o){var a=i[o],u=n.objectStore(a);e._hasGetAll="getAll"in u;for(var l=0;l<u.indexNames.length;++l){var d=u.indexNames[l],p=u.index(d).keyPath,v=typeof p=="string"?p:"["+xt(p).join("+")+"]";!t[a]||(p=t[a].idxByName[v])&&(p.name=d,delete t[a].idxByName[v],t[a].idxByName[d]=p)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&_.WorkerGlobalScope&&_ instanceof _.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}function Ar(e){return e.split(",").map(function(t,n){var i=(t=t.trim()).replace(/([&*]|\+\+)/g,""),o=/^\[/.test(i)?i.match(/^\[(.*)\]$/)[1].split("+"):i;return In(i,o||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),S(o),n===0)})}var Bi=(Gt.prototype._parseStoresSpec=function(e,t){C(e).forEach(function(n){if(e[n]!==null){var i=Ar(e[n]),o=i.shift();if(o.unique=!0,o.multi)throw new M.Schema("Primary key cannot be multi-valued");i.forEach(function(a){if(a.auto)throw new M.Schema("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new M.Schema("Index must have a name and cannot be an empty string")}),t[n]=Sn(n,o,i)}})},Gt.prototype.stores=function(n){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?T(this._cfg.storesSource,n):n;var n=t._versions,i={},o={};return n.forEach(function(a){T(i,a._cfg.storesSource),o=a._cfg.dbschema={},a._parseStoresSpec(i,o)}),t._dbSchema=o,Pn(t,[t._allTables,t,t.Transaction.prototype]),qt(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],C(o),o),t._storeNames=C(o),this},Gt.prototype.upgrade=function(e){return this._cfg.contentUpgrade=fn(this._cfg.contentUpgrade||Q,e),this},Gt);function Gt(){}function An(e,t){var n=e._dbNamesDB;return n||(n=e._dbNamesDB=new _e($t,{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),n.table("dbnames")}function $n(e){return e&&typeof e.databases=="function"}function Rn(e){return ke(function(){return F.letThrough=!0,e()})}function Bn(e){return!("from"in e)}var oe=function(e,t){if(!this){var n=new oe;return e&&"d"in e&&T(n,e),n}T(this,arguments.length?{d:1,from:e,to:1<arguments.length?t:e}:{d:0})};function bt(e,t,n){var i=V(t,n);if(!isNaN(i)){if(0<i)throw RangeError();if(Bn(e))return T(e,{from:t,to:n,d:1});var o=e.l,i=e.r;if(V(n,e.from)<0)return o?bt(o,t,n):e.l={from:t,to:n,d:1,l:null,r:null},Rr(e);if(0<V(t,e.to))return i?bt(i,t,n):e.r={from:t,to:n,d:1,l:null,r:null},Rr(e);V(t,e.from)<0&&(e.from=t,e.l=null,e.d=i?i.d+1:1),0<V(n,e.to)&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1),n=!e.r,o&&!e.l&&wt(e,o),i&&n&&wt(e,i)}}function wt(e,t){Bn(t)||function n(i,d){var a=d.from,u=d.to,l=d.l,d=d.r;bt(i,a,u),l&&n(i,l),d&&n(i,d)}(e,t)}function $r(e,t){var n=Ut(t),i=n.next();if(i.done)return!1;for(var o=i.value,a=Ut(e),u=a.next(o.from),l=u.value;!i.done&&!u.done;){if(V(l.from,o.to)<=0&&0<=V(l.to,o.from))return!0;V(o.from,l.from)<0?o=(i=n.next(l.from)).value:l=(u=a.next(o.from)).value}return!1}function Ut(e){var t=Bn(e)?null:{s:0,n:e};return{next:function(n){for(var i=0<arguments.length;t;)switch(t.s){case 0:if(t.s=1,i)for(;t.n.l&&V(n,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!i||V(n,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function Rr(e){var t,n,i=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((n=e.l)===null||n===void 0?void 0:n.d)||0),o=1<i?"r":i<-1?"l":"";o&&(t=o=="r"?"l":"r",n=c({},e),i=e[o],e.from=i.from,e.to=i.to,e[o]=i[o],n[o]=i[t],(e[t]=n).d=Br(n)),e.d=Br(e)}function Br(n){var t=n.r,n=n.l;return(t?n?Math.max(t.d,n.d):t.d:n?n.d:0)+1}function Wt(e,t){return C(t).forEach(function(n){e[n]?wt(e[n],t[n]):e[n]=function i(o){var a,u,l={};for(a in o)q(o,a)&&(u=o[a],l[a]=!u||typeof u!="object"||cr.has(u.constructor)?u:i(u));return l}(t[n])}),e}function Dn(e,t){return e.all||t.all||Object.keys(e).some(function(n){return t[n]&&$r(t[n],e[n])})}X(oe.prototype,((de={add:function(e){return wt(this,e),this},addKey:function(e){return bt(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(n){return bt(t,n,n)}),this},hasKey:function(e){var t=Ut(this).next(e).value;return t&&V(t.from,e)<=0&&0<=V(t.to,e)}})[un]=function(){return Ut(this)},de));var qe={},jn={},Ln=!1;function zt(e){Wt(jn,e),Ln||(Ln=!0,setTimeout(function(){Ln=!1,qn(jn,!(jn={}))},0))}function qn(e,t){t===void 0&&(t=!1);var n=new Set;if(e.all)for(var i=0,o=Object.values(qe);i<o.length;i++)Dr(u=o[i],e,n,t);else for(var a in e){var u,l=/^idb\:\/\/(.*)\/(.*)\//.exec(a);l&&(a=l[1],l=l[2],(u=qe["idb://".concat(a,"/").concat(l)])&&Dr(u,e,n,t))}n.forEach(function(d){return d()})}function Dr(e,t,n,i){for(var o=[],a=0,u=Object.entries(e.queries.query);a<u.length;a++){for(var l=u[a],d=l[0],p=[],v=0,f=l[1];v<f.length;v++){var w=f[v];Dn(t,w.obsSet)?w.subscribers.forEach(function(y){return n.add(y)}):i&&p.push(w)}i&&o.push([d,p])}if(i)for(var h=0,g=o;h<g.length;h++){var b=g[h],d=b[0],p=b[1];e.queries.query[d]=p}}function Di(e){var t=e._state,n=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?ee(t.dbOpenError):e});t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var i=t.openCanceller,o=Math.round(10*e.verno),a=!1;function u(){if(t.openCanceller!==i)throw new M.DatabaseClosed("db.open() was cancelled")}function l(){return new j(function(w,h){if(u(),!n)throw new M.MissingAPI;var g=e.name,b=t.autoSchema||!o?n.open(g):n.open(g,o);if(!b)throw new M.MissingAPI;b.onerror=pe(h),b.onblocked=J(e._fireOnBlocked),b.onupgradeneeded=J(function(y){var x;v=b.transaction,t.autoSchema&&!e._options.allowEmptyDB?(b.onerror=yt,v.abort(),b.result.close(),(x=n.deleteDatabase(g)).onsuccess=x.onerror=J(function(){h(new M.NoSuchDatabase("Database ".concat(g," doesnt exist")))})):(v.onerror=pe(h),y=y.oldVersion>Math.pow(2,62)?0:y.oldVersion,f=y<1,e.idbdb=b.result,a&&Ri(e,v),$i(e,y/10,v,h))},h),b.onsuccess=J(function(){v=null;var y,x,E,O,I,P=e.idbdb=b.result,R=xt(P.objectStoreNames);if(0<R.length)try{var K=P.transaction((O=R).length===1?O[0]:O,"readonly");if(t.autoSchema)x=P,E=K,(y=e).verno=x.version/10,E=y._dbSchema=Ft(0,x,E),y._storeNames=xt(x.objectStoreNames,0),qt(y,[y._allTables],C(E),E);else if(Mt(e,e._dbSchema,K),((I=Kn(Ft(0,(I=e).idbdb,K),I._dbSchema)).add.length||I.change.some(function(A){return A.add.length||A.change.length}))&&!a)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),P.close(),o=P.version+1,a=!0,w(l());Lt(e,K)}catch{}He.push(e),P.onversionchange=J(function(A){t.vcFired=!0,e.on("versionchange").fire(A)}),P.onclose=J(function(A){e.on("close").fire(A)}),f&&(I=e._deps,K=g,P=I.indexedDB,I=I.IDBKeyRange,$n(P)||K===$t||An(P,I).put({name:K}).catch(Q)),w()},h)}).catch(function(w){switch(w?.name){case"UnknownError":if(0<t.PR1398_maxLoop)return t.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),l();break;case"VersionError":if(0<o)return o=0,l()}return j.reject(w)})}var d,p=t.dbReadyResolve,v=null,f=!1;return j.race([i,(typeof navigator>"u"?j.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(w){function h(){return indexedDB.databases().finally(w)}d=setInterval(h,100),h()}).finally(function(){return clearInterval(d)}):Promise.resolve()).then(l)]).then(function(){return u(),t.onReadyBeingFired=[],j.resolve(Rn(function(){return e.on.ready.fire(e.vip)})).then(function w(){if(0<t.onReadyBeingFired.length){var h=t.onReadyBeingFired.reduce(fn,Q);return t.onReadyBeingFired=[],j.resolve(Rn(function(){return h(e.vip)})).then(w)}})}).finally(function(){t.openCanceller===i&&(t.onReadyBeingFired=null,t.isBeingOpened=!1)}).catch(function(w){t.dbOpenError=w;try{v&&v.abort()}catch{}return i===t.openCanceller&&e._close(),ee(w)}).finally(function(){t.openComplete=!0,p()}).then(function(){var w;return f&&(w={},e.tables.forEach(function(h){h.schema.indexes.forEach(function(g){g.name&&(w["idb://".concat(e.name,"/").concat(h.name,"/").concat(g.name)]=new oe(-1/0,[[[]]]))}),w["idb://".concat(e.name,"/").concat(h.name,"/")]=w["idb://".concat(e.name,"/").concat(h.name,"/:dels")]=new oe(-1/0,[[[]]])}),Se(mt).fire(w),qn(w,!0)),e})}function Nn(e){function t(a){return e.next(a)}var n=o(t),i=o(function(a){return e.throw(a)});function o(a){return function(d){var l=a(d),d=l.value;return l.done?d:d&&typeof d.then=="function"?d.then(n,i):S(d)?Promise.all(d).then(n,i):n(d)}}return o(t)()}function Vt(e,t,n){for(var i=S(e)?e.slice():[e],o=0;o<n;++o)i.push(t);return i}var ji={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return c(c({},e),{table:function(t){var n=e.table(t),i=n.schema,o={},a=[];function u(f,w,h){var g=vt(f),b=o[g]=o[g]||[],y=f==null?0:typeof f=="string"?1:f.length,x=0<w,x=c(c({},h),{name:x?"".concat(g,"(virtual-from:").concat(h.name,")"):h.name,lowLevelIndex:h,isVirtual:x,keyTail:w,keyLength:y,extractKey:Cn(f),unique:!x&&h.unique});return b.push(x),x.isPrimaryKey||a.push(x),1<y&&u(y===2?f[0]:f.slice(0,y-1),w+1,h),b.sort(function(E,O){return E.keyTail-O.keyTail}),x}t=u(i.primaryKey.keyPath,0,i.primaryKey),o[":id"]=[t];for(var l=0,d=i.indexes;l<d.length;l++){var p=d[l];u(p.keyPath,0,p)}function v(f){var w,h=f.query.index;return h.isVirtual?c(c({},f),{query:{index:h.lowLevelIndex,range:(w=f.query.range,h=h.keyTail,{type:w.type===1?2:w.type,lower:Vt(w.lower,w.lowerOpen?e.MAX_KEY:e.MIN_KEY,h),lowerOpen:!0,upper:Vt(w.upper,w.upperOpen?e.MIN_KEY:e.MAX_KEY,h),upperOpen:!0})}}):f}return c(c({},n),{schema:c(c({},i),{primaryKey:t,indexes:a,getIndexByKeyPath:function(f){return(f=o[vt(f)])&&f[0]}}),count:function(f){return n.count(v(f))},query:function(f){return n.query(v(f))},openCursor:function(f){var w=f.query.index,h=w.keyTail,g=w.isVirtual,b=w.keyLength;return g?n.openCursor(v(f)).then(function(x){return x&&y(x)}):n.openCursor(f);function y(x){return Object.create(x,{continue:{value:function(E){E!=null?x.continue(Vt(E,f.reverse?e.MAX_KEY:e.MIN_KEY,h)):f.unique?x.continue(x.key.slice(0,b).concat(f.reverse?e.MIN_KEY:e.MAX_KEY,h)):x.continue()}},continuePrimaryKey:{value:function(E,O){x.continuePrimaryKey(Vt(E,e.MAX_KEY,h),O)}},primaryKey:{get:function(){return x.primaryKey}},key:{get:function(){var E=x.key;return b===1?E[0]:E.slice(0,b)}},value:{get:function(){return x.value}}})}}})}})}};function Fn(e,t,n,i){return n=n||{},i=i||"",C(e).forEach(function(o){var a,u,l;q(t,o)?(a=e[o],u=t[o],typeof a=="object"&&typeof u=="object"&&a&&u?(l=sn(a))!==sn(u)?n[i+o]=t[o]:l==="Object"?Fn(a,u,n,i+o+"."):a!==u&&(n[i+o]=t[o]):a!==u&&(n[i+o]=t[o])):n[i+o]=void 0}),C(t).forEach(function(o){q(e,o)||(n[i+o]=t[o])}),n}function Mn(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var Li={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return c(c({},e),{table:function(t){var n=e.table(t),i=n.schema.primaryKey;return c(c({},n),{mutate:function(o){var a=F.trans,u=a.table(t).hook,l=u.deleting,d=u.creating,p=u.updating;switch(o.type){case"add":if(d.fire===Q)break;return a._promise("readwrite",function(){return v(o)},!0);case"put":if(d.fire===Q&&p.fire===Q)break;return a._promise("readwrite",function(){return v(o)},!0);case"delete":if(l.fire===Q)break;return a._promise("readwrite",function(){return v(o)},!0);case"deleteRange":if(l.fire===Q)break;return a._promise("readwrite",function(){return function f(w,h,g){return n.query({trans:w,values:!1,query:{index:i,range:h},limit:g}).then(function(b){var y=b.result;return v({type:"delete",keys:y,trans:w}).then(function(x){return 0<x.numFailures?Promise.reject(x.failures[0]):y.length<g?{failures:[],numFailures:0,lastResult:void 0}:f(w,c(c({},h),{lower:y[y.length-1],lowerOpen:!0}),g)})})}(o.trans,o.range,1e4)},!0)}return n.mutate(o);function v(f){var w,h,g,b=F.trans,y=f.keys||Mn(i,f);if(!y)throw new Error("Keys missing");return(f=f.type==="add"||f.type==="put"?c(c({},f),{keys:y}):c({},f)).type!=="delete"&&(f.values=m([],f.values)),f.keys&&(f.keys=m([],f.keys)),w=n,g=y,((h=f).type==="add"?Promise.resolve([]):w.getMany({trans:h.trans,keys:g,cache:"immutable"})).then(function(x){var E=y.map(function(O,I){var P,R,K,A=x[I],D={onerror:null,onsuccess:null};return f.type==="delete"?l.fire.call(D,O,A,b):f.type==="add"||A===void 0?(P=d.fire.call(D,O,f.values[I],b),O==null&&P!=null&&(f.keys[I]=O=P,i.outbound||ce(f.values[I],i.keyPath,O))):(P=Fn(A,f.values[I]),(R=p.fire.call(D,P,O,A,b))&&(K=f.values[I],Object.keys(R).forEach(function($){q(K,$)?K[$]=R[$]:ce(K,$,R[$])}))),D});return n.mutate(f).then(function(O){for(var I=O.failures,P=O.results,R=O.numFailures,O=O.lastResult,K=0;K<y.length;++K){var A=(P||y)[K],D=E[K];A==null?D.onerror&&D.onerror(I[K]):D.onsuccess&&D.onsuccess(f.type==="put"&&x[K]?f.values[K]:A)}return{failures:I,results:P,numFailures:R,lastResult:O}}).catch(function(O){return E.forEach(function(I){return I.onerror&&I.onerror(O)}),Promise.reject(O)})})}}})}})}};function jr(e,t,n){try{if(!t||t.keys.length<e.length)return null;for(var i=[],o=0,a=0;o<t.keys.length&&a<e.length;++o)V(t.keys[o],e[a])===0&&(i.push(n?Pe(t.values[o]):t.values[o]),++a);return i.length===e.length?i:null}catch{return null}}var qi={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var n=e.table(t);return c(c({},n),{getMany:function(i){if(!i.cache)return n.getMany(i);var o=jr(i.keys,i.trans._cache,i.cache==="clone");return o?j.resolve(o):n.getMany(i).then(function(a){return i.trans._cache={keys:i.keys,values:i.cache==="clone"?Pe(a):a},a})},mutate:function(i){return i.type!=="add"&&(i.trans._cache=null),n.mutate(i)}})}}}};function Lr(e,t){return e.trans.mode==="readonly"&&!!e.subscr&&!e.trans.explicit&&e.trans.db._options.cache!=="disabled"&&!t.schema.primaryKey.outbound}function qr(e,t){switch(e){case"query":return t.values&&!t.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Ni={stack:"dbcore",level:0,name:"Observability",create:function(e){var t=e.schema.name,n=new oe(e.MIN_KEY,e.MAX_KEY);return c(c({},e),{transaction:function(i,o,a){if(F.subscr&&o!=="readonly")throw new M.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(F.querier));return e.transaction(i,o,a)},table:function(i){var o=e.table(i),a=o.schema,u=a.primaryKey,f=a.indexes,l=u.extractKey,d=u.outbound,p=u.autoIncrement&&f.filter(function(h){return h.compound&&h.keyPath.includes(u.keyPath)}),v=c(c({},o),{mutate:function(h){function g($){return $="idb://".concat(t,"/").concat(i,"/").concat($),O[$]||(O[$]=new oe)}var b,y,x,E=h.trans,O=h.mutatedParts||(h.mutatedParts={}),I=g(""),P=g(":dels"),R=h.type,D=h.type==="deleteRange"?[h.range]:h.type==="delete"?[h.keys]:h.values.length<50?[Mn(u,h).filter(function($){return $}),h.values]:[],K=D[0],A=D[1],D=h.trans._cache;return S(K)?(I.addKeys(K),(D=R==="delete"||K.length===A.length?jr(K,D):null)||P.addKeys(K),(D||A)&&(b=g,y=D,x=A,a.indexes.forEach(function($){var L=b($.name||"");function U(z){return z!=null?$.extractKey(z):null}function W(z){return $.multiEntry&&S(z)?z.forEach(function(fe){return L.addKey(fe)}):L.addKey(z)}(y||x).forEach(function(z,ae){var G=y&&U(y[ae]),ae=x&&U(x[ae]);V(G,ae)!==0&&(G!=null&&W(G),ae!=null&&W(ae))})}))):K?(A={from:(A=K.lower)!==null&&A!==void 0?A:e.MIN_KEY,to:(A=K.upper)!==null&&A!==void 0?A:e.MAX_KEY},P.add(A),I.add(A)):(I.add(n),P.add(n),a.indexes.forEach(function($){return g($.name).add(n)})),o.mutate(h).then(function($){return!K||h.type!=="add"&&h.type!=="put"||(I.addKeys($.results),p&&p.forEach(function(L){for(var U=h.values.map(function(G){return L.extractKey(G)}),W=L.keyPath.findIndex(function(G){return G===u.keyPath}),z=0,fe=$.results.length;z<fe;++z)U[z][W]=$.results[z];g(L.name).addKeys(U)})),E.mutatedParts=Wt(E.mutatedParts||{},O),$})}}),f=function(g){var b=g.query,g=b.index,b=b.range;return[g,new oe((g=b.lower)!==null&&g!==void 0?g:e.MIN_KEY,(b=b.upper)!==null&&b!==void 0?b:e.MAX_KEY)]},w={get:function(h){return[u,new oe(h.key)]},getMany:function(h){return[u,new oe().addKeys(h.keys)]},count:f,query:f,openCursor:f};return C(w).forEach(function(h){v[h]=function(g){var b=F.subscr,y=!!b,x=Lr(F,o)&&qr(h,g)?g.obsSet={}:b;if(y){var E=function(A){return A="idb://".concat(t,"/").concat(i,"/").concat(A),x[A]||(x[A]=new oe)},O=E(""),I=E(":dels"),b=w[h](g),y=b[0],b=b[1];if((h==="query"&&y.isPrimaryKey&&!g.values?I:E(y.name||"")).add(b),!y.isPrimaryKey){if(h!=="count"){var P=h==="query"&&d&&g.values&&o.query(c(c({},g),{values:!1}));return o[h].apply(this,arguments).then(function(A){if(h==="query"){if(d&&g.values)return P.then(function(U){return U=U.result,O.addKeys(U),A});var D=g.values?A.result.map(l):A.result;(g.values?O:I).addKeys(D)}else if(h==="openCursor"){var $=A,L=g.values;return $&&Object.create($,{key:{get:function(){return I.addKey($.primaryKey),$.key}},primaryKey:{get:function(){var U=$.primaryKey;return I.addKey(U),U}},value:{get:function(){return L&&O.addKey($.primaryKey),$.value}}})}return A})}I.add(n)}}return o[h].apply(this,arguments)}}),v}})}};function Nr(e,t,n){if(n.numFailures===0)return t;if(t.type==="deleteRange")return null;var i=t.keys?t.keys.length:"values"in t&&t.values?t.values.length:1;return n.numFailures===i?null:(t=c({},t),S(t.keys)&&(t.keys=t.keys.filter(function(o,a){return!(a in n.failures)})),"values"in t&&S(t.values)&&(t.values=t.values.filter(function(o,a){return!(a in n.failures)})),t)}function Gn(e,t){return n=e,((i=t).lower===void 0||(i.lowerOpen?0<V(n,i.lower):0<=V(n,i.lower)))&&(e=e,(t=t).upper===void 0||(t.upperOpen?V(e,t.upper)<0:V(e,t.upper)<=0));var n,i}function Fr(e,t,w,i,o,a){if(!w||w.length===0)return e;var u=t.query.index,l=u.multiEntry,d=t.query.range,p=i.schema.primaryKey.extractKey,v=u.extractKey,f=(u.lowLevelIndex||u).extractKey,w=w.reduce(function(h,g){var b=h,y=[];if(g.type==="add"||g.type==="put")for(var x=new oe,E=g.values.length-1;0<=E;--E){var O,I=g.values[E],P=p(I);x.hasKey(P)||(O=v(I),(l&&S(O)?O.some(function($){return Gn($,d)}):Gn(O,d))&&(x.addKey(P),y.push(I)))}switch(g.type){case"add":var R=new oe().addKeys(t.values?h.map(function(L){return p(L)}):h),b=h.concat(t.values?y.filter(function(L){return L=p(L),!R.hasKey(L)&&(R.addKey(L),!0)}):y.map(function(L){return p(L)}).filter(function(L){return!R.hasKey(L)&&(R.addKey(L),!0)}));break;case"put":var K=new oe().addKeys(g.values.map(function(L){return p(L)}));b=h.filter(function(L){return!K.hasKey(t.values?p(L):L)}).concat(t.values?y:y.map(function(L){return p(L)}));break;case"delete":var A=new oe().addKeys(g.keys);b=h.filter(function(L){return!A.hasKey(t.values?p(L):L)});break;case"deleteRange":var D=g.range;b=h.filter(function(L){return!Gn(p(L),D)})}return b},e);return w===e?e:(w.sort(function(h,g){return V(f(h),f(g))||V(p(h),p(g))}),t.limit&&t.limit<1/0&&(w.length>t.limit?w.length=t.limit:e.length===t.limit&&w.length<t.limit&&(o.dirty=!0)),a?Object.freeze(w):w)}function Mr(e,t){return V(e.lower,t.lower)===0&&V(e.upper,t.upper)===0&&!!e.lowerOpen==!!t.lowerOpen&&!!e.upperOpen==!!t.upperOpen}function Fi(e,t){return function(n,i,o,a){if(n===void 0)return i!==void 0?-1:0;if(i===void 0)return 1;if((i=V(n,i))===0){if(o&&a)return 0;if(o)return 1;if(a)return-1}return i}(e.lower,t.lower,e.lowerOpen,t.lowerOpen)<=0&&0<=function(n,i,o,a){if(n===void 0)return i!==void 0?1:0;if(i===void 0)return-1;if((i=V(n,i))===0){if(o&&a)return 0;if(o)return-1;if(a)return 1}return i}(e.upper,t.upper,e.upperOpen,t.upperOpen)}function Mi(e,t,n,i){e.subscribers.add(n),i.addEventListener("abort",function(){var o,a;e.subscribers.delete(n),e.subscribers.size===0&&(o=e,a=t,setTimeout(function(){o.subscribers.size===0&&Ke(a,o)},3e3))})}var Gi={stack:"dbcore",level:0,name:"Cache",create:function(e){var t=e.schema.name;return c(c({},e),{transaction:function(n,i,o){var a,u,l=e.transaction(n,i,o);return i==="readwrite"&&(u=(a=new AbortController).signal,o=function(d){return function(){if(a.abort(),i==="readwrite"){for(var p=new Set,v=0,f=n;v<f.length;v++){var w=f[v],h=qe["idb://".concat(t,"/").concat(w)];if(h){var g=e.table(w),b=h.optimisticOps.filter(function(L){return L.trans===l});if(l._explicit&&d&&l.mutatedParts)for(var y=0,x=Object.values(h.queries.query);y<x.length;y++)for(var E=0,O=(R=x[y]).slice();E<O.length;E++)Dn((K=O[E]).obsSet,l.mutatedParts)&&(Ke(R,K),K.subscribers.forEach(function(L){return p.add(L)}));else if(0<b.length){h.optimisticOps=h.optimisticOps.filter(function(L){return L.trans!==l});for(var I=0,P=Object.values(h.queries.query);I<P.length;I++)for(var R,K,A,D=0,$=(R=P[I]).slice();D<$.length;D++)(K=$[D]).res!=null&&l.mutatedParts&&(d&&!K.dirty?(A=Object.isFrozen(K.res),A=Fr(K.res,K.req,b,g,K,A),K.dirty?(Ke(R,K),K.subscribers.forEach(function(L){return p.add(L)})):A!==K.res&&(K.res=A,K.promise=j.resolve({result:A}))):(K.dirty&&Ke(R,K),K.subscribers.forEach(function(L){return p.add(L)})))}}}p.forEach(function(L){return L()})}}},l.addEventListener("abort",o(!1),{signal:u}),l.addEventListener("error",o(!1),{signal:u}),l.addEventListener("complete",o(!0),{signal:u})),l},table:function(n){var i=e.table(n),o=i.schema.primaryKey;return c(c({},i),{mutate:function(a){var u=F.trans;if(o.outbound||u.db._options.cache==="disabled"||u.explicit||u.idbtrans.mode!=="readwrite")return i.mutate(a);var l=qe["idb://".concat(t,"/").concat(n)];return l?(u=i.mutate(a),a.type!=="add"&&a.type!=="put"||!(50<=a.values.length||Mn(o,a).some(function(d){return d==null}))?(l.optimisticOps.push(a),a.mutatedParts&&zt(a.mutatedParts),u.then(function(d){0<d.numFailures&&(Ke(l.optimisticOps,a),(d=Nr(0,a,d))&&l.optimisticOps.push(d),a.mutatedParts&&zt(a.mutatedParts))}),u.catch(function(){Ke(l.optimisticOps,a),a.mutatedParts&&zt(a.mutatedParts)})):u.then(function(d){var p=Nr(0,c(c({},a),{values:a.values.map(function(v,f){var w;return d.failures[f]?v:(v=(w=o.keyPath)!==null&&w!==void 0&&w.includes(".")?Pe(v):c({},v),ce(v,o.keyPath,d.results[f]),v)})}),d);l.optimisticOps.push(p),queueMicrotask(function(){return a.mutatedParts&&zt(a.mutatedParts)})}),u):i.mutate(a)},query:function(a){if(!Lr(F,i)||!qr("query",a))return i.query(a);var u=((p=F.trans)===null||p===void 0?void 0:p.db._options.cache)==="immutable",f=F,l=f.requery,d=f.signal,p=function(g,b,y,x){var E=qe["idb://".concat(g,"/").concat(b)];if(!E)return[];if(!(b=E.queries[y]))return[null,!1,E,null];var O=b[(x.query?x.query.index.name:null)||""];if(!O)return[null,!1,E,null];switch(y){case"query":var I=O.find(function(P){return P.req.limit===x.limit&&P.req.values===x.values&&Mr(P.req.query.range,x.query.range)});return I?[I,!0,E,O]:[O.find(function(P){return("limit"in P.req?P.req.limit:1/0)>=x.limit&&(!x.values||P.req.values)&&Fi(P.req.query.range,x.query.range)}),!1,E,O];case"count":return I=O.find(function(P){return Mr(P.req.query.range,x.query.range)}),[I,!!I,E,O]}}(t,n,"query",a),v=p[0],f=p[1],w=p[2],h=p[3];return v&&f?v.obsSet=a.obsSet:(f=i.query(a).then(function(g){var b=g.result;if(v&&(v.res=b),u){for(var y=0,x=b.length;y<x;++y)Object.freeze(b[y]);Object.freeze(b)}else g.result=Pe(b);return g}).catch(function(g){return h&&v&&Ke(h,v),Promise.reject(g)}),v={obsSet:a.obsSet,promise:f,subscribers:new Set,type:"query",req:a,dirty:!1},h?h.push(v):(h=[v],(w=w||(qe["idb://".concat(t,"/").concat(n)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[a.query.index.name||""]=h)),Mi(v,h,l,d),v.promise.then(function(g){return{result:Fr(g.result,a,w?.optimisticOps,i,v,u)}})}})}})}};function Yt(e,t){return new Proxy(e,{get:function(n,i,o){return i==="db"?t:Reflect.get(n,i,o)}})}var _e=(te.prototype.version=function(e){if(isNaN(e)||e<.1)throw new M.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new M.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,n=t.filter(function(i){return i._cfg.version===e})[0];return n||(n=new this.Version(e),t.push(n),t.sort(Ai),n.stores({}),this._state.autoSchema=!1,n)},te.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||F.letThrough||this._vip)?e():new j(function(n,i){if(t._state.openComplete)return i(new M.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._state.autoOpen)return void i(new M.DatabaseClosed);t.open().catch(Q)}t._state.dbReadyPromise.then(n,i)}).then(e)},te.prototype.use=function(e){var t=e.stack,n=e.create,i=e.level,o=e.name;return o&&this.unuse({stack:t,name:o}),e=this._middlewares[t]||(this._middlewares[t]=[]),e.push({stack:t,create:n,level:i??10,name:o}),e.sort(function(a,u){return a.level-u.level}),this},te.prototype.unuse=function(e){var t=e.stack,n=e.name,i=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(o){return i?o.create!==i:!!n&&o.name!==n})),this},te.prototype.open=function(){var e=this;return De(xe,function(){return Di(e)})},te.prototype._close=function(){var e=this._state,t=He.indexOf(this);if(0<=t&&He.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}e.isBeingOpened||(e.dbReadyPromise=new j(function(n){e.dbReadyResolve=n}),e.openCanceller=new j(function(n,i){e.cancelOpen=i}))},te.prototype.close=function(n){var t=(n===void 0?{disableAutoOpen:!0}:n).disableAutoOpen,n=this._state;t?(n.isBeingOpened&&n.cancelOpen(new M.DatabaseClosed),this._close(),n.autoOpen=!1,n.dbOpenError=new M.DatabaseClosed):(this._close(),n.autoOpen=this._options.autoOpen||n.isBeingOpened,n.openComplete=!1,n.dbOpenError=null)},te.prototype.delete=function(e){var t=this;e===void 0&&(e={disableAutoOpen:!0});var n=0<arguments.length&&typeof arguments[0]!="object",i=this._state;return new j(function(o,a){function u(){t.close(e);var l=t._deps.indexedDB.deleteDatabase(t.name);l.onsuccess=J(function(){var d,p,v;d=t._deps,p=t.name,v=d.indexedDB,d=d.IDBKeyRange,$n(v)||p===$t||An(v,d).delete(p).catch(Q),o()}),l.onerror=pe(a),l.onblocked=t._fireOnBlocked}if(n)throw new M.InvalidArgument("Invalid closeOptions argument to db.delete()");i.isBeingOpened?i.dbReadyPromise.then(u):u()})},te.prototype.backendDB=function(){return this.idbdb},te.prototype.isOpen=function(){return this.idbdb!==null},te.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},te.prototype.hasFailed=function(){return this._state.dbOpenError!==null},te.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(te.prototype,"tables",{get:function(){var e=this;return C(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),te.prototype.transaction=function(){var e=(function(t,n,i){var o=arguments.length;if(o<2)throw new M.InvalidArgument("Too few arguments");for(var a=new Array(o-1);--o;)a[o-1]=arguments[o];return i=a.pop(),[t,ur(a),i]}).apply(this,arguments);return this._transaction.apply(this,e)},te.prototype._transaction=function(e,t,n){var i=this,o=F.trans;o&&o.db===this&&e.indexOf("!")===-1||(o=null);var a,u,l=e.indexOf("?")!==-1;e=e.replace("!","").replace("?","");try{if(u=t.map(function(p){if(p=p instanceof i.Table?p.name:p,typeof p!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return p}),e=="r"||e===wn)a=wn;else{if(e!="rw"&&e!=_n)throw new M.InvalidArgument("Invalid transaction mode: "+e);a=_n}if(o){if(o.mode===wn&&a===_n){if(!l)throw new M.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");o=null}o&&u.forEach(function(p){if(o&&o.storeNames.indexOf(p)===-1){if(!l)throw new M.SubTransaction("Table "+p+" not included in parent transaction.");o=null}}),l&&o&&!o.active&&(o=null)}}catch(p){return o?o._promise(null,function(v,f){f(p)}):ee(p)}var d=(function p(v,f,w,h,g){return j.resolve().then(function(){var b=F.transless||F,y=v._createTransaction(f,w,v._dbSchema,h);if(y.explicit=!0,b={trans:y,transless:b},h)y.idbtrans=h.idbtrans;else try{y.create(),y.idbtrans._explicit=!0,v._state.PR1398_maxLoop=3}catch(O){return O.name===ln.InvalidState&&v.isOpen()&&0<--v._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),v.close({disableAutoOpen:!1}),v.open().then(function(){return p(v,f,w,null,g)})):ee(O)}var x,E=cn(g);return E&&Xe(),b=j.follow(function(){var O;(x=g.call(y,y))&&(E?(O=Ee.bind(null,null),x.then(O,O)):typeof x.next=="function"&&typeof x.throw=="function"&&(x=Nn(x)))},b),(x&&typeof x.then=="function"?j.resolve(x).then(function(O){return y.active?O:ee(new M.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):b.then(function(){return x})).then(function(O){return h&&y._resolve(),y._completion.then(function(){return O})}).catch(function(O){return y._reject(O),ee(O)})})}).bind(null,this,a,u,o,n);return o?o._promise(a,d,"lock"):F.trans?De(F.transless,function(){return i._whenReady(d)}):this._whenReady(d)},te.prototype.table=function(e){if(!q(this._allTables,e))throw new M.InvalidTable("Table ".concat(e," does not exist"));return this._allTables[e]},te);function te(e,t){var n=this;this._middlewares={},this.verno=0;var i=te.dependencies;this._options=t=c({addons:te.addons,autoOpen:!0,indexedDB:i.indexedDB,IDBKeyRange:i.IDBKeyRange,cache:"cloned"},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange},i=t.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var o,a,u,l,d,p={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Q,dbReadyPromise:null,cancelOpen:Q,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:t.autoOpen};p.dbReadyPromise=new j(function(f){p.dbReadyResolve=f}),p.openCanceller=new j(function(f,w){p.cancelOpen=w}),this._state=p,this.name=e,this.on=dt(this,"populate","blocked","versionchange","close",{ready:[fn,Q]}),this.on.ready.subscribe=or(this.on.ready.subscribe,function(f){return function(w,h){te.vip(function(){var g,b=n._state;b.openComplete?(b.dbOpenError||j.resolve().then(w),h&&f(w)):b.onReadyBeingFired?(b.onReadyBeingFired.push(w),h&&f(w)):(f(w),g=n,h||f(function y(){g.on.ready.unsubscribe(w),g.on.ready.unsubscribe(y)}))})}}),this.Collection=(o=this,ht(Oi.prototype,function(x,y){this.db=o;var h=br,g=null;if(y)try{h=y()}catch(E){g=E}var b=x._ctx,y=b.table,x=y.hook.reading.fire;this._ctx={table:y,index:b.index,isPrimKey:!b.index||y.schema.primKey.keyPath&&b.index===y.schema.primKey.name,range:h,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:g,or:b.or,valueMapper:x!==st?x:null}})),this.Table=(a=this,ht(kr.prototype,function(f,w,h){this.db=a,this._tx=h,this.name=f,this.schema=w,this.hook=a._allTables[f]?a._allTables[f].hook:dt(null,{creating:[mi,Q],reading:[yi,st],updating:[vi,Q],deleting:[gi,Q]})})),this.Transaction=(u=this,ht(Ci.prototype,function(f,w,h,g,b){var y=this;this.db=u,this.mode=f,this.storeNames=w,this.schema=h,this.chromeTransactionDurability=g,this.idbtrans=null,this.on=dt(this,"complete","error","abort"),this.parent=b||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new j(function(x,E){y._resolve=x,y._reject=E}),this._completion.then(function(){y.active=!1,y.on.complete.fire()},function(x){var E=y.active;return y.active=!1,y.on.error.fire(x),y.parent?y.parent._reject(x):E&&y.idbtrans&&y.idbtrans.abort(),ee(x)})})),this.Version=(l=this,ht(Bi.prototype,function(f){this.db=l,this._cfg={version:f,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(d=this,ht(Cr.prototype,function(f,w,h){if(this.db=d,this._ctx={table:f,index:w===":id"?null:w,or:h},this._cmp=this._ascending=V,this._descending=function(g,b){return V(b,g)},this._max=function(g,b){return 0<V(g,b)?g:b},this._min=function(g,b){return V(g,b)<0?g:b},this._IDBKeyRange=d._deps.IDBKeyRange,!this._IDBKeyRange)throw new M.MissingAPI})),this.on("versionchange",function(f){0<f.newVersion?console.warn("Another connection wants to upgrade database '".concat(n.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(n.name,"'. Closing db now to resume the delete request.")),n.close({disableAutoOpen:!1})}),this.on("blocked",function(f){!f.newVersion||f.newVersion<f.oldVersion?console.warn("Dexie.delete('".concat(n.name,"') was blocked")):console.warn("Upgrade '".concat(n.name,"' blocked by other connection holding version ").concat(f.oldVersion/10))}),this._maxKey=gt(t.IDBKeyRange),this._createTransaction=function(f,w,h,g){return new n.Transaction(f,w,h,n._options.chromeTransactionDurability,g)},this._fireOnBlocked=function(f){n.on("blocked").fire(f),He.filter(function(w){return w.name===n.name&&w!==n&&!w._state.vcFired}).map(function(w){return w.on("versionchange").fire(f)})},this.use(qi),this.use(Gi),this.use(Ni),this.use(ji),this.use(Li);var v=new Proxy(this,{get:function(f,w,h){if(w==="_vip")return!0;if(w==="table")return function(b){return Yt(n.table(b),v)};var g=Reflect.get(f,w,h);return g instanceof kr?Yt(g,v):w==="tables"?g.map(function(b){return Yt(b,v)}):w==="_createTransaction"?function(){return Yt(g.apply(this,arguments),v)}:g}});this.vip=v,i.forEach(function(f){return f(n)})}var Qt,de=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Ui=(Un.prototype.subscribe=function(e,t,n){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:n})},Un.prototype[de]=function(){return this},Un);function Un(e){this._subscribe=e}try{Qt={indexedDB:_.indexedDB||_.mozIndexedDB||_.webkitIndexedDB||_.msIndexedDB,IDBKeyRange:_.IDBKeyRange||_.webkitIDBKeyRange}}catch{Qt={indexedDB:null,IDBKeyRange:null}}function Gr(e){var t,n=!1,i=new Ui(function(o){var a=cn(e),u,l=!1,d={},p={},v={get closed(){return l},unsubscribe:function(){l||(l=!0,u&&u.abort(),f&&Se.storagemutated.unsubscribe(h))}};o.start&&o.start(v);var f=!1,w=function(){return bn(g)},h=function(b){Wt(d,b),Dn(p,d)&&w()},g=function(){var b,y,x;!l&&Qt.indexedDB&&(d={},b={},u&&u.abort(),u=new AbortController,x=function(E){var O=Ye();try{a&&Xe();var I=ke(e,E);return I=a?I.finally(Ee):I}finally{O&&Qe()}}(y={subscr:b,signal:u.signal,requery:w,querier:e,trans:null}),Promise.resolve(x).then(function(E){n=!0,t=E,l||y.signal.aborted||(d={},function(O){for(var I in O)if(q(O,I))return;return 1}(p=b)||f||(Se(mt,h),f=!0),bn(function(){return!l&&o.next&&o.next(E)}))},function(E){n=!1,["DatabaseClosedError","AbortError"].includes(E?.name)||l||bn(function(){l||o.error&&o.error(E)})}))};return setTimeout(w,0),v});return i.hasValue=function(){return n},i.getValue=function(){return t},i}var Ne=_e;function Wn(e){var t=Ce;try{Ce=!0,Se.storagemutated.fire(e),qn(e,!0)}finally{Ce=t}}X(Ne,c(c({},Et),{delete:function(e){return new Ne(e,{addons:[]}).delete()},exists:function(e){return new Ne(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return t=Ne.dependencies,n=t.indexedDB,t=t.IDBKeyRange,($n(n)?Promise.resolve(n.databases()).then(function(i){return i.map(function(o){return o.name}).filter(function(o){return o!==$t})}):An(n,t).toCollection().primaryKeys()).then(e)}catch{return ee(new M.MissingAPI)}var t,n},defineClass:function(){return function(e){T(this,e)}},ignoreTransaction:function(e){return F.trans?De(F.transless,e):e()},vip:Rn,async:function(e){return function(){try{var t=Nn(e.apply(this,arguments));return t&&typeof t.then=="function"?t:j.resolve(t)}catch(n){return ee(n)}}},spawn:function(e,t,n){try{var i=Nn(e.apply(n,t||[]));return i&&typeof i.then=="function"?i:j.resolve(i)}catch(o){return ee(o)}},currentTransaction:{get:function(){return F.trans||null}},waitFor:function(e,t){return t=j.resolve(typeof e=="function"?Ne.ignoreTransaction(e):e).timeout(t||6e4),F.trans?F.trans.waitFor(t):t},Promise:j,debug:{get:function(){return he},set:function(e){dr(e)}},derive:ge,extend:T,props:X,override:or,Events:dt,on:Se,liveQuery:Gr,extendObservabilitySet:Wt,getByKeyPath:ve,setByKeyPath:ce,delByKeyPath:function(e,t){typeof t=="string"?ce(e,t,void 0):"length"in t&&[].map.call(t,function(n){ce(e,n,void 0)})},shallowClone:sr,deepClone:Pe,getObjectDiff:Fn,cmp:V,asap:ar,minKey:-1/0,addons:[],connections:He,errnames:ln,dependencies:Qt,cache:qe,semVer:"4.0.11",version:"4.0.11".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,2*n)})})),Ne.maxKey=gt(Ne.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Se(mt,function(e){Ce||(e=new CustomEvent(On,{detail:e}),Ce=!0,dispatchEvent(e),Ce=!1)}),addEventListener(On,function(e){e=e.detail,Ce||Wn(e)}));var et,Ce=!1,Ur=function(){};return typeof BroadcastChannel<"u"&&((Ur=function(){(et=new BroadcastChannel(On)).onmessage=function(e){return e.data&&Wn(e.data)}})(),typeof et.unref=="function"&&et.unref(),Se(mt,function(e){Ce||et.postMessage(e)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(e){if(!_e.disableBfCache&&e.persisted){he&&console.debug("Dexie: handling persisted pagehide"),et?.close();for(var t=0,n=He;t<n.length;t++)n[t].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(e){!_e.disableBfCache&&e.persisted&&(he&&console.debug("Dexie: handling persisted pageshow"),Ur(),Wn({all:new oe(-1/0,[[]])}))})),j.rejectionMapper=function(e,t){return!e||e instanceof ze||e instanceof TypeError||e instanceof SyntaxError||!e.name||!fr[e.name]?e:(t=new fr[e.name](t||e.message,e),"stack"in e&&ie(t,"stack",{get:function(){return this.inner.stack}}),t)},dr(he),c(_e,Object.freeze({__proto__:null,Dexie:_e,liveQuery:Gr,Entity:wr,cmp:V,PropModification:pt,replacePrefix:function(e,t){return new pt({replacePrefix:[e,t]})},add:function(e){return new pt({add:e})},remove:function(e){return new pt({remove:e})},default:_e,RangeSet:oe,mergeRanges:wt,rangesOverlap:$r}),{default:_e}),_e})}(tn)),tn.exports}var Do=Bo();const ir=so(Do),ti=Symbol.for("Dexie"),on=globalThis[ti]||(globalThis[ti]=ir);if(ir.semVer!==on.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${ir.semVer} and ${on.semVer}`);const{liveQuery:Go,mergeRanges:Uo,rangesOverlap:Wo,RangeSet:zo,cmp:Vo,Entity:Yo,PropModification:Qo,replacePrefix:Xo,add:Ho,remove:Zo}=on;class jo extends on{catalogues;systems;systemrows;constructor(){super("nr-editor"),this.version(6).stores({catalogues:"id, content.catalogue.id, content.catalogue.gameSystemId",systems:"id",systemrows:"id"})}}const Jt=new jo;class Jo extends $o{gameSystem=null;catalogueFiles=So();allLoaded;loadedCatalogues={};github;unresolvedLinks={};index={};update;async loadData(r,s){return await rn(this,r,s)}findOptionById(r){for(const s of Object.values(this.loadedCatalogues))if(s.index&&s.index[r])return s.index[r]}unloadAll(){super.unloadAll();for(const r of Object.values(this.loadedCatalogues))r.reset();this.loadedCatalogues={},this.index={},delete this.allLoaded}async loadAll(r){let s=Object.values(this.catalogueFiles).length+1,c=0;if(this.allLoaded||console.log("Loading all catalogues in",this.gameSystem?.gameSystem?.name),this.gameSystem){r&&await r(c,s,`Loading ${this.gameSystem.gameSystem.name}`),(await this.loadCatalogue({targetId:this.gameSystem.gameSystem.id})).processForEditor(),c++;for(const _ of Object.values(this.catalogueFiles))r&&await r(c,s,`Loading ${_.catalogue.name}`),(await this.loadCatalogue({targetId:_.catalogue.id})).processForEditor(),c++,r&&await r(c,s,`Loading ${_.catalogue.name}`)}this.allLoaded=!0}getLoadedCatalogue(r,s){const c=r.targetId||r.name;return this.loadedCatalogues[c]}addLoadedCatalogue(r,s){this.loadedCatalogues[r.id]=r}getAllLoadedCatalogues(){return this.gameSystem?.gameSystem.id?Object.values(this.loadedCatalogues):[]}getId(){return this.gameSystem?.gameSystem.id}getCatalogueInfo(r){if(this.gameSystem?.gameSystem.id===r.targetId)return this.gameSystem?.gameSystem;for(const s of Object.values(this.catalogueFiles))if(s.catalogue.id===r.targetId)return s.catalogue}getAllCatalogueFiles(){return[...this.gameSystem?[this.gameSystem]:[],...Object.values(this.catalogueFiles)]}setSystem(r){this.gameSystem=r;const s=Jt.systems.put({id:r.gameSystem.id,content:r});return this.update&&this.update(r),s}setCatalogue(r){const s=r.catalogue.id;this.catalogueFiles[s]=r;const c=Jt.catalogues.put({id:r.catalogue.id,content:r});return this.update&&this.update(r),c}removeCatalogue(r){for(const[s,c]of Object.entries(this.catalogueFiles))c.catalogue.id===r.catalogue.id&&delete this.catalogueFiles[s]}async getData(r,s){if(r.targetId==this.gameSystem?.gameSystem.id)return this.gameSystem;if(r.targetId in this.catalogueFiles)return this.catalogueFiles[r.targetId];const c=await Jt.catalogues.get({"content.catalogue.id":r.targetId});if(c)return c.content;const m=await Jt.systems.get(r.targetId);if(m)return m.content;const _=r.name?`name ${r.name}`:`id ${r.targetId}`;throw Error(`Couldn't import catalogue with ${_}, perhaps it wasnt uploaded?`)}}export{Jo as GameSystemFiles};
//# sourceMappingURL=Ct-5TeT_.js.map
